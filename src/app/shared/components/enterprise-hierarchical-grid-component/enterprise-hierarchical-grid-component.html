<div class="enterprise-grid-container">
  <!-- <div class="loading-shade" *ngIf="isLoading">
    <mat-spinner strokeWidth="3" diameter="50"></mat-spinner>
    <p>Loading data...</p>
  </div> -->

  <div class="grid-toolbar">
    <div class="date-range-container">
      <div class="search-wrapper" style="position: relative; display: flex; align-items: center;">
        <app-search-input [value]="globalSearchQuery" (onSearch)="onGlobalSearch($event)"></app-search-input>
        <button *ngIf="globalSearchQuery" mat-icon-button (click)="globalSearchQuery=''; triggerDataLoad()"
          style="position: absolute; right: 8px;">
        </button>
      </div>

      <mat-form-field appearance="outline" class="modern-datepicker">
        <mat-label>Select PO Date Range</mat-label>
        <mat-date-range-input [rangePicker]="picker">
          <input matStartDate [value]="fromDate" placeholder="Start Date" (dateChange)="applyDateFilter()">
          <input matEndDate [value]="toDate" placeholder="End Date" (dateChange)="applyDateFilter()">
        </mat-date-range-input>
        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-date-range-picker #picker></mat-date-range-picker>
      </mat-form-field>
    </div>

    <div class="right-actions">
      <button mat-icon-button [matMenuTriggerFor]="columnMenu" title="Hide/Show Columns" style="margin-right: 8px;">
        <mat-icon color="primary">view_column</mat-icon>
      </button>

      <mat-menu #columnMenu="matMenu" class="custom-column-menu">
        <div class="menu-header">Show/Hide Columns</div>

        <div class="menu-actions-row" (click)="$event.stopPropagation()">
          <button mat-button color="primary" class="mini-link-btn" (click)="toggleAllColumns(true)">Select All</button>
          <span class="v-divider">|</span>
          <button mat-button color="warn" class="mini-link-btn" (click)="toggleAllColumns(false)">Clear All</button>
        </div>

        <div class="menu-scroll-container">
          <div *ngFor="let col of columns" class="menu-item-checkbox" (click)="$event.stopPropagation()">
            <mat-checkbox [(ngModel)]="col.visible" (change)="onColumnToggle()" color="primary">
              {{ col.header }}
            </mat-checkbox>
          </div>
        </div>
      </mat-menu>
      <button mat-flat-button color="warn" *ngIf="selection.hasValue()" (click)="onBulkDeleteClick()" class="action-btn"
        style="margin-right: 8px;">
        <mat-icon>delete_sweep</mat-icon> Bulk Delete ({{selection.selected.length}})
      </button>
      <button mat-flat-button color="primary" (click)="onAddNewClick()">+ {{ addNewLabel }}</button>
    </div>
  </div>

  <div class="responsive-table-wrapper">
    <table mat-table [dataSource]="dataSource" multiTemplateDataRows matSort (matSortChange)="onSortChange($event)"
      cdkDropList cdkDropListOrientation="horizontal" (cdkDropListDropped)="drop($event)">

      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef style="width: 50px; padding-right: 0;">
          <mat-checkbox (change)="$event ? masterToggle() : null" [checked]="selection.hasValue() && isAllSelected()"
            [indeterminate]="selection.hasValue() && !isAllSelected()">
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row" (click)="$event.stopPropagation()" style="width: 50px; padding-right: 0;">
          <mat-checkbox (click)="$event.stopPropagation()" (change)="$event ? onParentCheck(row) : null"
            [checked]="selection.isSelected(row)">
          </mat-checkbox>
        </td>
      </ng-container>

      <ng-container *ngFor="let col of columns" [matColumnDef]="col.field">
        <th mat-header-cell *matHeaderCellDef cdkDrag [style.width.px]="col.width" [mat-sort-header]="col.field"
          [style.display]="col.visible === false ? 'none' : 'table-cell'">
          <div class="header-main-container">
            <span class="header-label">{{ col.header }}</span>
            <div class="header-right-side">
              <button *ngIf="col.isFilterable" mat-icon-button [matMenuTriggerFor]="filterMenu"
                (click)="$event.stopPropagation()">
                <mat-icon [class.active-filter]="col.filterValue">filter_list</mat-icon>
              </button>
              <div *ngIf="col.isResizable" class="resizer-bar"
                (mousedown)="onResize(col, $event); $event.stopPropagation()"></div>
            </div>
          </div>
          <mat-menu #filterMenu="matMenu">
            <div style="padding: 10px;" (click)="$event.stopPropagation()">
              <mat-form-field appearance="outline" style="width: 100%;">
                <mat-label>Search {{ col.header }}</mat-label>
                <input matInput [(ngModel)]="col.filterValue" (keyup)="applyFilter()">
                <button *ngIf="col.filterValue" matSuffix mat-icon-button (click)="col.filterValue=''; applyFilter()">
                  <mat-icon>close</mat-icon>
                </button>
              </mat-form-field>
            </div>
          </mat-menu>
        </th>
        <td mat-cell *matCellDef="let row" [style.display]="col.visible === false ? 'none' : 'table-cell'">
          {{ col.cell ? col.cell(row) : row[col.field] }}
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef style="width: 100px; text-align: center;"> Actions </th>
        <td mat-cell *matCellDef="let row">
          <div *ngIf="!selection.hasValue() && !childSelection.hasValue()"
            style="display: flex; justify-content: center; gap: 8px;">
            <button mat-icon-button color="primary" (click)="$event.stopPropagation(); onEditChild(row, $event)">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="$event.stopPropagation(); onDeleteChild(row, $event)"
              title="Delete">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
          <div *ngIf="selection.isSelected(row)"
            style="text-align: center; color: #999; font-size: 12px; font-style: italic;">
            Selected
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="expandedDetail">
        <td mat-cell *matCellDef="let element" [attr.colspan]="displayedColumns.length">
          <div class="detail-panel" [class.is-expanded]="element === expandedElement">
            <div class="child-grid-wrapper" *ngIf="element === expandedElement">

              <div class="child-header" style="display: flex; justify-content: space-between; align-items: center;">
                <span class="child-title">Detailed Line Items</span>
                <button mat-flat-button color="warn" size="small" *ngIf="childSelection.hasValue()"
                  (click)="onBulkDeleteChildItems(element)"
                  style="line-height: 28px; height: 30px; font-size: 12px; margin-right: 15px;">
                  <mat-icon style="font-size: 16px; width: 16px; height: 16px;">delete_sweep</mat-icon>
                  Delete Selected ({{childSelection.selected.length}})
                </button>
              </div>

              <div class="child-table-scroll">
                <table class="inner-table" cdkDropList cdkDropListOrientation="horizontal"
                  (cdkDropListDropped)="dropChild($event)">
                  <thead>
                    <tr class="child-header-row">
                      <th class="child-th" style="width: 50px;">
                        <mat-checkbox (change)="$event ? childMasterToggle(element) : null"
                          [checked]="isAllChildSelected(element)"></mat-checkbox>
                      </th>
                      <th *ngFor="let cCol of childColumns" cdkDrag class="child-th" [style.width.px]="cCol.width">
                        <div class="header-main-container">
                          <div class="header-label-group" (click)="sortChild(cCol.field, element)">
                            <span class="header-label">{{ cCol.header }}</span>
                            <mat-icon class="sort-indicator" *ngIf="currentChildSortField === cCol.field">
                              {{ sortChildDir ? 'arrow_upward' : 'arrow_downward' }}
                            </mat-icon>
                          </div>
                          <div class="header-right-side">
                            <button mat-icon-button [matMenuTriggerFor]="cFilterMenu"
                              (click)="$event.stopPropagation()">
                              <mat-icon [class.active-filter]="cCol.filterValue"
                                style="font-size: 16px;">filter_list</mat-icon>
                            </button>
                            <div class="resizer-bar"
                              (mousedown)="onResizeChild(cCol, $event); $event.stopPropagation()"></div>
                          </div>
                        </div>
                        <mat-menu #cFilterMenu="matMenu">
                          <div style="padding: 10px;" (click)="$event.stopPropagation()">
                            <mat-form-field appearance="outline" style="width: 100%;">
                              <mat-label>Search {{ cCol.header }}</mat-label>
                              <input matInput [(ngModel)]="cCol.filterValue" (keyup)="applyChildFilter(element, cCol)">
                              <button *ngIf="cCol.filterValue" matSuffix mat-icon-button
                                (click)="cCol.filterValue=''; applyChildFilter(element, cCol)">
                                <mat-icon>close</mat-icon>
                              </button>
                            </mat-form-field>
                          </div>
                        </mat-menu>
                      </th>
                      <th class="child-th" style="width: 100px; text-align: center;">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let childRow of element[childDataField]" class="child-row">
                      <td style="text-align: center;">
                        <mat-checkbox (click)="$event.stopPropagation()"
                          (change)="$event ? onChildCheck(childRow) : null"
                          [checked]="childSelection.isSelected(childRow)"></mat-checkbox>
                      </td>
                      <td *ngFor="let cCol of childColumns" [style.text-align]="cCol.align">{{ childRow[cCol.field] }}
                      </td>
                      <td>
                        <div *ngIf="!childSelection.hasValue()"
                          style="display: flex; gap: 4px; justify-content: center;">
                          <button mat-icon-button (click)="onEditChild(element, childRow)" color="primary"
                            title="Edit Item">
                            <mat-icon style="font-size: 18px;">edit</mat-icon>
                          </button>
                          <button mat-icon-button (click)="onDeleteChild(element, childRow)" color="warn"
                            title="Delete Item">
                            <mat-icon style="font-size: 18px;">delete</mat-icon>
                          </button>
                        </div>
                        <div *ngIf="childSelection.isSelected(childRow)" style="text-align: center;">
                          <mat-icon color="primary" style="font-size: 18px;">check_circle</mat-icon>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                  <tfoot>
                    <tr class="child-footer-row">
                      <td [attr.colspan]="childColumns.length - 1" class="footer-spacer"></td>

                      <td colspan="2" class="footer-summary-container">
                        <div class="summary-box">
                          <div class="summary-item">
                            <span class="label">Sub-Total:</span>
                            <span class="value">{{ (element.subTotal || 0) | currency:'INR' }}</span>
                          </div>

                          <div class="summary-item">
                            <span class="label">Total Tax:</span>
                            <span class="value">{{ (element.totalTax || 0) | currency:'INR' }}</span>
                          </div>

                          <div class="summary-item grand-total-section">
                            <span class="label">GRAND TOTAL:</span>
                            <span class="value">{{ (element.grandTotal || 0) | currency:'INR' }}</span>
                          </div>
                        </div>
                      </td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="master-row" (click)="toggleRow(row)"></tr>
      <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" [attr.colspan]="displayedColumns.length" style="padding: 40px 0;">
          <div class="no-records-wrapper">
            <mat-icon style="font-size: 32px; color: #ccc;">manage_search</mat-icon>
            <p style="margin: 10px 0; color: #666; font-weight: 500;">No records found matching your criteria.</p>
          </div>
        </td>
      </tr>
    </table>
  </div>
  <mat-paginator [length]="totalRecords" [pageSize]="pageSize" (page)="onPageChange($event)"></mat-paginator>
</div>