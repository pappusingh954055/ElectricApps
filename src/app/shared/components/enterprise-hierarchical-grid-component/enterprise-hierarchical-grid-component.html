<!-- <div class="enterprise-grid-container"> -->
  <div class="grid-toolbar">
    <div class="date-range-container">
      <app-search-input [value]="globalSearchQuery" (onSearch)="onGlobalSearch($event)"></app-search-input>

      <mat-form-field appearance="outline" class="modern-datepicker">
        <mat-label>Search by Date Range</mat-label>
        <mat-date-range-input [rangePicker]="picker">
          <input matStartDate [value]="fromDate" placeholder="Start" (dateChange)="applyDateFilter()">
          <input matEndDate [value]="toDate" placeholder="End" (dateChange)="applyDateFilter()">
        </mat-date-range-input>
        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-date-range-picker #picker></mat-date-range-picker>
      </mat-form-field>
    </div>

    <div class="right-actions">
      <button mat-icon-button [matMenuTriggerFor]="columnMenu" matTooltip="Custom Columns">
        <mat-icon color="primary">view_column</mat-icon>
      </button>

      <mat-menu #columnMenu="matMenu" class="custom-column-menu">
        <div class="menu-header">Manage Visibility</div>
        <div class="menu-actions-row" (click)="$event.stopPropagation()">
          <button mat-button color="primary" class="mini-link-btn" (click)="toggleAllColumns(true)">Select All</button>
          <span class="v-divider">|</span>
          <button mat-button color="warn" class="mini-link-btn" (click)="toggleAllColumns(false)">Clear All</button>
        </div>
        <div class="menu-scroll-container">
          <div *ngFor="let col of columns" class="menu-item-checkbox" (click)="$event.stopPropagation()">
            <mat-checkbox [(ngModel)]="col.visible" (change)="onColumnToggle()" color="primary">
              {{ col.header }}
            </mat-checkbox>
          </div>
        </div>
      </mat-menu>

      <!-- Contextual Action Buttons (Show only when more than one record is selected) -->
      <div class="contextual-buttons-group" *ngIf="selection.selected.length > 1">
        <button mat-raised-button color="warn" *ngIf="userRole !== 'Manager' && userRole !== 'Warehouse'" (click)="onBulkDeleteClick()" class="bulk-action-btn">
          <mat-icon>delete_sweep</mat-icon> Bulk Delete
        </button>

        <button mat-raised-button  *ngIf="userRole === 'User'" (click)="onBulkApproveClick()" class="bulk-action-btn glass-btn success-btn">
          <mat-icon>done_all</mat-icon> Submit Approval
        </button>

        <button mat-raised-button color="primary" *ngIf="userRole === 'Manager'" (click)="onBulkDraftApprovedClick()" class="bulk-action-btn success-btn">
          <mat-icon>verified</mat-icon> Massive Approve
        </button>

        <button mat-raised-button color="warn" *ngIf="userRole === 'Manager'" (click)="onBulkPORejectedClick()" class="bulk-action-btn">
          <mat-icon>cancel</mat-icon> Mass Reject
        </button>

        <button mat-raised-button color="accent" *ngIf="userRole === 'Warehouse'" (click)="onBulkCreateGrnClick()" class="bulk-action-btn success-btn">
          <mat-icon>inventory</mat-icon> Bulk Receive
        </button>
      </div>
      
      <button mat-raised-button color="primary" *ngIf="userRole !== 'Manager' && userRole !== 'Warehouse'" (click)="onAddNewClick()" class="main-add-btn">
        <mat-icon>add</mat-icon>
        {{ addNewLabel }}
      </button>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state-container" *ngIf="!isLoading && (!dataSource || dataSource.data.length === 0)">
    <div class="empty-state-content">
      <mat-icon class="empty-icon">manage_search</mat-icon>
      <h3 class="empty-title">No Records Found</h3>
      <p class="empty-subtitle">We couldn't find any records matching your search criteria.</p>
      <button mat-raised-button color="primary" (click)="clearGlobalSearch()" *ngIf="globalSearchQuery">Clear Search</button>
    </div>
  </div>

  <div class="main-grid-content" [style.display]="(!isLoading && dataSource && dataSource.data.length > 0) ? 'flex' : 'none'">
    <div class="responsive-table-wrapper">
      <table mat-table [dataSource]="dataSource" multiTemplateDataRows matSort (matSortChange)="onSortChange($event)"
        cdkDropList cdkDropListOrientation="horizontal" (cdkDropListDropped)="drop($event)">

        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef>
            <mat-checkbox (change)="$event ? masterToggle() : null" [checked]="selection.hasValue() && isAllSelected()"
              [indeterminate]="selection.hasValue() && !isAllSelected()">
            </mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let row" (click)="$event.stopPropagation()">
            <mat-checkbox (click)="$event.stopPropagation()" (change)="$event ? onParentCheck(row) : null"
              [checked]="selection.isSelected(row)" [disabled]="!isRowSelectable(row)">
            </mat-checkbox>
          </td>
        </ng-container>

        <ng-container *ngFor="let col of columns" [matColumnDef]="col.field">
          <th mat-header-cell *matHeaderCellDef cdkDrag [style.width.px]="col.width" [mat-sort-header]="col.field"
            [style.display]="col.visible === false ? 'none' : 'table-cell'">
            <div class="header-main-container">
              <span class="header-label">{{ col.header }}</span>
              <div class="header-right-side">
                <button *ngIf="col.isFilterable" mat-icon-button [matMenuTriggerFor]="filterMenu"
                  (click)="$event.stopPropagation()">
                  <mat-icon [class.active-filter]="col.filterValue">filter_list</mat-icon>
                </button>
                <div *ngIf="col.isResizable" class="resizer-bar"
                  (mousedown)="onResize(col, $event); $event.stopPropagation()"></div>
              </div>
            </div>
            <mat-menu #filterMenu="matMenu">
              <div style="padding: 10px;" (click)="$event.stopPropagation()">
                <mat-form-field appearance="outline" style="width: 100%;">
                  <mat-label>Search {{ col.header }}</mat-label>
                  <input matInput [(ngModel)]="col.filterValue" (keyup)="applyFilter()">
                  <button *ngIf="col.filterValue" matSuffix mat-icon-button (click)="col.filterValue=''; applyFilter()">
                    <mat-icon>close</mat-icon>
                  </button>
                </mat-form-field>
              </div>
            </mat-menu>
          </th>
          <td mat-cell *matCellDef="let row" [style.display]="col.visible === false ? 'none' : 'table-cell'">
            <ng-container *ngIf="col.field === 'status'; else normalCell">
              <span class="status-badge" 
                    [ngClass]="getStatusBadgeClass(col.cell ? col.cell(row) : row[col.field])"
                    [innerHTML]="col.cell ? col.cell(row) : row[col.field]">
              </span>
            </ng-container>
            <ng-template #normalCell>
              {{ col.cell ? col.cell(row) : row[col.field] }}
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
    <th mat-header-cell *matHeaderCellDef> Actions </th>

   <td mat-cell *matCellDef="let row">
    <div class="po-actions-wrapper">

     <ng-container *ngIf="(row.status === 'Draft' || row.status === 'Rejected') && userRole === 'User'">
      <button mat-icon-button color="primary" 
              (click)="$event.stopPropagation(); handleAction('EDIT', row)" 
              matTooltip="Edit PO">
        <mat-icon>edit</mat-icon>
      </button>

      <button mat-icon-button color="warn" 
              (click)="$event.stopPropagation(); handleAction('DELETE', row)" 
              matTooltip="Delete PO">
        <mat-icon>delete</mat-icon>
      </button>

      <button mat-icon-button 
              (click)="$event.stopPropagation(); handleAction('SUBMIT', row)" 
              matTooltip="Draft Submit for Approval"
              class="btn-submit">
        <mat-icon>send</mat-icon>
      </button>
  </ng-container>

      <ng-container *ngIf="row.status === 'Submitted' && userRole === 'Manager'">
        <button mat-icon-button color="primary" (click)="$event.stopPropagation(); handleAction('APPROVE', row)" matTooltip="Approve PO">
          <mat-icon>check_circle</mat-icon>
        </button>
        <button mat-icon-button color="warn" (click)="$event.stopPropagation(); handleAction('REJECT', row)" matTooltip="Reject PO">
          <mat-icon>cancel</mat-icon>
        </button>
      </ng-container>

      <ng-container *ngIf="row.status === 'Approved' && userRole === 'Warehouse'">
        <button mat-icon-button color="accent" (click)="$event.stopPropagation(); handleAction('CREATE_GRN', row)" matTooltip="Create GRN">
          <mat-icon>local_shipping</mat-icon>
        </button>
      </ng-container>

      <ng-container *ngIf="row.status === 'Approved' && userRole !== 'Warehouse'">
        <button mat-icon-button color="primary" (click)="$event.stopPropagation(); handleAction('VIEW', row)" matTooltip="View Details">
          <mat-icon style="opacity: 0.7;">visibility</mat-icon>
        </button>
        <button mat-icon-button (click)="$event.stopPropagation(); handleAction('PRINT', row)" matTooltip="Print PO">
          <mat-icon style="color: #607d8b;">print</mat-icon>
        </button>
      </ng-container>

      <ng-container *ngIf="row.status === 'Submitted' && userRole === 'User'">
        <div style="display: flex; align-items: center; gap: 4px;">
          <mat-icon style="color: #ff9800;">hourglass_empty</mat-icon>
          <span style="font-size: 11px; color: #888;">Pending Approval</span>
        </div>
      </ng-container>

      <ng-container *ngIf="row.status === 'Received' || row.status === 'Partially Received'">
        <button mat-icon-button (click)="$event.stopPropagation(); handleAction('PRINT', row)" matTooltip="Print PO">
          <mat-icon color="primary">print</mat-icon>
        </button>
        
        <!-- Red Truck: Process Return (Priority: Hide if any inwarding is pending) -->
        <button mat-icon-button color="warn" 
                *ngIf="(row.totalRejected || 0) > 0 && !((row.totalAccepted || 0) < (row.totalOrdered || 0))"
                (click)="$event.stopPropagation(); handleAction('PROCESS_RETURN', row)" 
                matTooltip="Process Purchase Return (Outward)">
          <mat-icon>local_shipping</mat-icon>
        </button>
        
        <!-- Blue Truck: Inward Replacement (Priority: Always show if inwarding is baki) -->
        <button mat-icon-button color="primary" 
                *ngIf="(row.totalAccepted || 0) < (row.totalOrdered || 0)"
                (click)="$event.stopPropagation(); handleAction('CREATE_GRN', row)" 
                matTooltip="Inward Replacement/Pending Items">
          <mat-icon>local_shipping</mat-icon>
        </button>

        <!-- Verified: Show only if nothing is pending return and nothing is missing -->
        <mat-icon *ngIf="!((row.totalRejected || 0) > 0) && !((row.totalAccepted || 0) < (row.totalOrdered || 0))" 
                  style="color: #4caf50;" matTooltip="Order Completed">verified</mat-icon>
      </ng-container>

    </div>
  </td>

  </ng-container>

        <ng-container matColumnDef="expandedDetail">
          <td mat-cell *matCellDef="let element" [attr.colspan]="displayedColumns.length">
            <div class="detail-panel" [class.is-expanded]="element === expandedElement">
              <div class="child-grid-wrapper" *ngIf="element === expandedElement">
                <div class="child-header" style="display: flex; justify-content: space-between; align-items: center;">
                  <span class="child-title">Detailed Line Items</span>
                  <button mat-raised-button color="warn" size="small" *ngIf="childSelection.hasValue()"
                    (click)="onBulkDeleteChildItems(element)"
                    style="line-height: 28px; height: 30px; font-size: 12px; margin-right: 15px;">
                    <mat-icon style="font-size: 16px; width: 16px; height: 16px;">delete_sweep</mat-icon>
                    Delete Selected ({{childSelection.selected.length}})
                  </button>
                </div>

                <div class="child-table-scroll">
                  <table class="inner-table" cdkDropList cdkDropListOrientation="horizontal"
                    (cdkDropListDropped)="dropChild($event)">
                    <thead>
                      <tr class="child-header-row">
                        <th class="child-th" style="width: 50px;">
                          <mat-checkbox (change)="$event ? childMasterToggle(element) : null"
                            [checked]="isAllChildSelected(element)" [disabled]="element.status !== 'Draft'">
                          </mat-checkbox>
                        </th>
                        <th *ngFor="let cCol of childColumns" cdkDrag class="child-th" [style.width.px]="cCol.width">
                          <div class="header-main-container">
                            <div class="header-label-group" (click)="sortChild(cCol.field, element)">
                              <span class="header-label">{{ cCol.header }}</span>
                              <mat-icon class="sort-indicator" *ngIf="currentChildSortField === cCol.field">
                                {{ sortChildDir ? 'arrow_upward' : 'arrow_downward' }}
                              </mat-icon>
                            </div>
                            <div class="header-right-side">
                              <button mat-icon-button [matMenuTriggerFor]="cFilterMenu"
                                (click)="$event.stopPropagation()">
                                <mat-icon [class.active-filter]="cCol.filterValue"
                                  style="font-size: 16px;">filter_list</mat-icon>
                              </button>
                              <div class="resizer-bar"
                                (mousedown)="onResizeChild(cCol, $event); $event.stopPropagation()"></div>
                            </div>
                          </div>
                          <mat-menu #cFilterMenu="matMenu">
                            <div style="padding: 10px;" (click)="$event.stopPropagation()">
                              <mat-form-field appearance="outline" style="width: 100%;">
                                <mat-label>Search {{ cCol.header }}</mat-label>
                                <input matInput [(ngModel)]="cCol.filterValue" (keyup)="applyChildFilter(element, cCol)">
                                <button *ngIf="cCol.filterValue" matSuffix mat-icon-button
                                  (click)="cCol.filterValue=''; applyChildFilter(element, cCol)">
                                  <mat-icon>close</mat-icon>
                                </button>
                              </mat-form-field>
                            </div>
                          </mat-menu>
                        </th>
                        <th class="child-th" style="width: 100px; text-align: center;">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let childRow of element[childDataField]" class="child-row">
                        <td style="text-align: center;">
                          <mat-checkbox (click)="$event.stopPropagation()"
                            (change)="$event ? onChildCheck(childRow) : null"
                            [checked]="childSelection.isSelected(childRow)" [disabled]="element.status !== 'Draft'">
                          </mat-checkbox>
                        </td>
                        <td *ngFor="let cCol of childColumns" [style.text-align]="cCol.align">
                          <span [ngClass]="{
                            'qty-success': (cCol.field === 'receivedQty' && childRow.receivedQty >= childRow.qty && childRow.qty > 0) || (cCol.field === 'acceptedQty' && childRow.acceptedQty > 0),
                            'qty-warning': cCol.field === 'receivedQty' && childRow.receivedQty > 0 && childRow.receivedQty < childRow.qty,
                            'qty-danger': cCol.field === 'rejectedQty' && childRow.rejectedQty > 0,
                            'qty-pending': cCol.field === 'pendingQty' && (childRow.pendingQty > 0 || childRow.qty > childRow.receivedQty)
                          }">
                            {{ cCol.cell ? cCol.cell(childRow) : childRow[cCol.field] }}
                          </span>
                        </td>
                        <td>
                          <div *ngIf="!childSelection.hasValue()"
                            style="display: flex; gap: 4px; justify-content: center;">
                            @if (element.status === 'Draft' && userRole === 'User') {
                            <button mat-icon-button (click)="onEditChild(element, childRow)" color="primary"
                              title="Edit Item">
                              <mat-icon style="font-size: 18px;">edit</mat-icon>
                            </button>
                            <button mat-icon-button (click)="onDeleteChild(element, childRow)" color="warn"
                              title="Delete Item">
                              <mat-icon style="font-size: 18px;">delete</mat-icon>
                            </button>
                            } @else {
                            <mat-icon style="font-size: 18px; color: #bdbdbd;" title="Locked">lock</mat-icon>
                            }
                          </div>
                        </td>
                      </tr>
                    </tbody>
                    <tfoot>
                      <tr class="child-footer-row">
                        <td [attr.colspan]="childColumns.length" class="footer-spacer"></td>
                        <td class="footer-summary-container" colspan="2">
                          <div class="summary-box">
                            <div class="summary-item">
                              <span class="label">Sub-Total:</span>
                              <span class="value">{{ calculateSubTotal(element) | currency:'INR' }}</span>
                            </div>
                            <div class="summary-item">
                              <span class="label">Total Tax:</span>
                              <span class="value">{{ (element.totalTax || 0) | currency:'INR' }}</span>
                            </div>
                            <div class="summary-item grand-total-section">
                              <span class="label">GRAND TOTAL:</span>
                              <span class="value">{{ (element.grandTotal || 0) | currency:'INR' }}</span>
                            </div>
                          </div>
                        </td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="master-row" (click)="toggleRow(row)"></tr>
        <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>
      </table>
    </div>
    <mat-paginator [length]="totalRecords" 
                   [pageSize]="pageSize" 
                   [pageSizeOptions]="[5, 10, 25, 50, 100]" 
                   showFirstLastButtons
                   (page)="onPageChange($event)"
                   class="grid-paginator">
    </mat-paginator>
  </div>
<!-- </div> -->