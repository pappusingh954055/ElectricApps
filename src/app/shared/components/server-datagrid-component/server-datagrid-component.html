<div class="datagrid-container">
  <div class="grid-loader" *ngIf="loading">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <div class="grid-header-actions">
    <div class="search-container">
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Global Search</mat-label>
        <input matInput placeholder="Search all fields..." (input)="onSearch($any($event.target).value)" />
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>

    <div class="button-container" *ngIf="selection.size > 0">
      <button mat-stroked-button color="warn" (click)="clearSelection()">
        <mat-icon>clear_all</mat-icon>
        <span class="btn-text">Clear ({{ selection.size }})</span>
      </button>
    </div>
  </div>

  <div class="table-wrapper">
    <table mat-table [dataSource]="data" class="server-datagrid" cdkDropList cdkDropListOrientation="horizontal"
      (cdkDropListDropped)="dropColumn($event)">

      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef class="sticky-left select-col">
          <div class="header-container-inner">
            <div class="header-top-row">
              <mat-checkbox [checked]="isHeaderChecked()" (change)="toggleAll($event)"></mat-checkbox>
            </div>
            <div class="filter-row placeholder"></div>
          </div>
        </th>
        <td mat-cell *matCellDef="let row" class="sticky-left select-col">
          <mat-checkbox [checked]="selection.has(row)" (change)="toggleRow(row)"></mat-checkbox>
        </td>
      </ng-container>

      <ng-container *ngFor="let col of visibleColumns" [matColumnDef]="col.field">
        <th mat-header-cell *matHeaderCellDef cdkDrag [style.width.px]="col.width">
          <div class="header-container-inner">
            <div class="header-top-row" (click)="onSort($event, col)">
              <span class="header-text">{{ col.header }}</span>
              <mat-icon *ngIf="col.sortable && request.sortBy === col.field" class="sort-icon"
                [class.desc]="request.sortDirection === 'desc'">arrow_upward</mat-icon>
            </div>
            <div class="filter-row" (click)="$event.stopPropagation()">
              <input class="column-filter-input" type="text" placeholder="Filter..."
                (input)="onColumnFilter(col.field, $any($event.target).value)">
            </div>
          </div>
          <span class="resize-handle" (mousedown)="startResize($event, col)"></span>
        </th>
        <td mat-cell *matCellDef="let row">
          {{ col.cell ? col.cell(row) : row[col.field] }}
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="sticky-right actions-col">
          <div class="header-container-inner">
            <div class="header-top-row">
              <span class="header-text">Actions</span>
              <button mat-icon-button class="mini-trigger" [matMenuTriggerFor]="columnMenu"
                (click)="$event.stopPropagation()">
                <mat-icon>more_vert</mat-icon>
              </button>
            </div>
            <div class="filter-row placeholder"></div>
          </div>
        </th>
        <td mat-cell *matCellDef="let row" class="sticky-right actions-col">
          <div class="action-btn-group">
            <button mat-icon-button color="primary" (click)="edit.emit(row)"><mat-icon>edit</mat-icon></button>
            <button mat-icon-button color="warn" (click)="delete.emit([row])"><mat-icon>delete</mat-icon></button>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumnsWithActions(); sticky: true"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumnsWithActions()" class="clickable-row"></tr>
    </table>
  </div>

  <mat-paginator [length]="totalCount" [pageSize]="request.pageSize" [pageSizeOptions]="[5,10,20,50,100]"
    (page)="onPageChange($event)"></mat-paginator>
</div>

<mat-menu #columnMenu="matMenu" class="custom-column-menu" xPosition="before">
  <div class="menu-container" (click)="$event.stopPropagation()">
    <div class="menu-header">Columns [Hide / Show]</div>

    <div class="search-wrapper">
      <mat-icon class="search-icon">search</mat-icon>
      <input type="text" class="menu-search-input" placeholder="Search columns"
        (input)="onColumnSearch($any($event.target).value)">
    </div>

    <div class="column-grid-vertical">
      <mat-checkbox *ngFor="let col of filteredColumns" [checked]="col.visible"
        (change)="toggleColumn(col, $event.checked)">
        {{ col.header }}
      </mat-checkbox>
    </div>

    <div class="menu-footer">
      <button class="menu-reset-btn" (click)="resetColumns()">
        <mat-icon>restart_alt</mat-icon>
        <span>Reset to Default</span>
      </button>
    </div>
  </div>
</mat-menu>