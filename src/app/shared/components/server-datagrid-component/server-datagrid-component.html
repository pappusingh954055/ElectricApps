<div class="datagrid-container">
    <div class="grid-loader" *ngIf="loading">
        <mat-spinner diameter="40"></mat-spinner>
    </div>

    <div class="grid-header-actions">
        <div class="left-actions">
            <!-- <mat-form-field appearance="outline" class="search-box">
                <mat-label>Global Search</mat-label>
                <input matInput placeholder="Search all fields..." (input)="onSearch($any($event.target).value)" />
                <mat-icon matSuffix>search</mat-icon>
            </mat-form-field> -->

            <button mat-flat-button color="accent" (click)="exportToExcel()" [disabled]="loading || data.length === 0">
                <mat-icon>download</mat-icon>
                Export Excel
            </button>
        </div>

        <button mat-stroked-button color="warn" *ngIf="selection.size > 0" (click)="clearSelection()">
            <mat-icon>clear_all</mat-icon>
            Clear ({{ selection.size }})
        </button>
    </div>

    <div class="table-wrapper">
        <table mat-table [dataSource]="data" class="server-datagrid" cdkDropList cdkDropListOrientation="horizontal"
            (cdkDropListDropped)="dropColumn($event)">

            <!-- SELECT -->
            <ng-container matColumnDef="select">
                <th mat-header-cell *matHeaderCellDef class="sticky-left select-col">
                    <mat-checkbox [checked]="isHeaderChecked()" [disabled]="loading" (change)="toggleAll($event)">
                    </mat-checkbox>
                </th>
                <td mat-cell *matCellDef="let row" class="sticky-left select-col">
                    <mat-checkbox [checked]="selection.has(row)" [disabled]="loading" (change)="toggleRow(row)">
                    </mat-checkbox>
                </td>
            </ng-container>

            <!-- DYNAMIC COLUMNS -->
            <ng-container *ngFor="let col of visibleColumns" [matColumnDef]="col.field">
                <th mat-header-cell *matHeaderCellDef cdkDrag cdkDragBoundary=".mat-header-row"
                    [style.width.px]="col.width" class="resizable-header">

                    <div class="header-container-inner">

                        <!-- HEADER TOP -->
                        <div class="header-top-row">
                            <div class="header-main-content" (click)="onSort($event, col)">
                                <span class="header-text">{{ col.header }}</span>

                                <mat-icon *ngIf="col.sortable && request.sortBy === col.field" class="sort-icon"
                                    [class.desc]="request.sortDirection === 'desc'">
                                    arrow_upward
                                </mat-icon>
                            </div>


                        </div>

                        <!-- âœ… FILTER ROW (FIXED) -->
                        <div class="filter-row" (click)="$event.stopPropagation()">
                            <input class="column-filter-input" type="text" [placeholder]="'Filter ' + col.header"
                                (keyup)="$event.stopPropagation()"
                                (input)="onColumnFilter(col.field, $any($event.target).value)">
                        </div>

                    </div>

                    <span class="resize-handle" (mousedown)="startResize($event, col)">
                    </span>

                    <div class="drag-placeholder" *cdkDragPlaceholder></div>
                </th>

                <td mat-cell *matCellDef="let row" [style.width.px]="col.width">
                    {{ col.cell ? col.cell(row) : row[col.field] }}
                </td>
            </ng-container>

            <!-- ACTIONS -->
            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="sticky-right actions-col">
                    <div class="header-container-inner">
                        <div class="header-top-row">
                            <span class="header-text">Actions</span>

                            <button mat-icon-button class="column-menu-trigger" [matMenuTriggerFor]="columnMenu"
                                (click)="$event.stopPropagation()">
                                <mat-icon>more_vert</mat-icon>
                            </button>
                        </div>

                        <!-- Empty filter row to align height -->
                        <div class="filter-row placeholder"></div>
                    </div>
                </th>


                <td mat-cell *matCellDef="let row" class="sticky-right actions-col">
                    <button mat-icon-button color="primary" [disabled]="loading" (click)="edit.emit(row)">
                        <mat-icon>edit</mat-icon>
                    </button>

                    <button mat-icon-button color="warn" [disabled]="loading" (click)="delete.emit([row])">
                        <mat-icon>delete</mat-icon>
                    </button>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumnsWithActions(); sticky: true" class="header-row">
            </tr>

            <tr mat-row *matRowDef="let row; columns: displayedColumnsWithActions()" class="clickable-row"
                (click)="onRowClick($event, row)">
            </tr>

        </table>
    </div>

    <mat-paginator [disabled]="loading" [length]="totalCount" [pageSize]="request.pageSize"
        [pageSizeOptions]="[5,10,20,50,100]" (page)="onPageChange($event)">
    </mat-paginator>
</div>

<!-- COLUMN MENU -->
<mat-menu #columnMenu="matMenu" yPosition="below" xPosition="before" class="column-menu">

    <!-- Header -->
    <div class="menu-header">
        Columns [Hide / Show]
    </div>
    <mat-form-field appearance="outline" class="column-search">
        <mat-label>Search columns</mat-label>
        <input matInput [value]="columnSearch" />
    </mat-form-field>

    <div class="menu-actions">
        <button mat-button (click)="showAllColumns()">Select All</button>
        <button mat-button (click)="hideAllColumns()">None</button>
    </div>

    <!-- Column checkboxes -->
    <mat-checkbox *ngFor="let col of filteredColumns" [checked]="col.visible" class="column-toggle"
        (change)="col.visible = $event.checked; updateDisplayedColumns()" (click)="$event.stopPropagation()">
        {{ col.header }}
    </mat-checkbox>


    <!-- Divider -->
    <mat-divider></mat-divider>

    <!-- Reset Action -->
    <button mat-menu-item class="reset-columns-btn" (click)="resetColumns(); columnMenu.closed">
        <mat-icon>restart_alt</mat-icon>
        Reset Columns
    </button>

</mat-menu>