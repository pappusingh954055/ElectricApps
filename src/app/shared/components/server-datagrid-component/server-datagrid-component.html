<div class="datagrid-container">
    <div class="grid-loader" *ngIf="loading">
        <mat-spinner diameter="40"></mat-spinner>
    </div>

    <div class="grid-header-actions">
        <div class="left-actions">
            <mat-form-field appearance="outline" class="search-box">
                <mat-label>Global Search</mat-label>
                <input matInput (input)="onSearch($any($event.target).value)" placeholder="Search all fields..." />
                <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>

            <button mat-flat-button color="accent" (click)="exportToExcel()" [disabled]="loading || data.length === 0">
                <mat-icon>download</mat-icon> Export Excel
            </button>
        </div>

        <button mat-stroked-button color="warn" *ngIf="selection.size > 0" (click)="clearSelection()">
            <mat-icon>clear_all</mat-icon> Clear ({{selection.size}})
        </button>
    </div>

    <div class="table-wrapper">
        <table mat-table [dataSource]="data" class="server-datagrid" cdkDropList cdkDropListOrientation="horizontal" (cdkDropListDropped)="dropColumn($event)">

            <ng-container matColumnDef="select">
                <th mat-header-cell *matHeaderCellDef class="sticky-left select-col">
                    <mat-checkbox (change)="toggleAll($event)" [checked]="isHeaderChecked()" [disabled]="loading"></mat-checkbox>
                </th>
                <td mat-cell *matCellDef="let row" class="sticky-left select-col">
                    <mat-checkbox (change)="toggleRow(row)" [checked]="selection.has(row)" [disabled]="loading"></mat-checkbox>
                </td>
            </ng-container>

            <ng-container *ngFor="let col of visibleColumns" [matColumnDef]="col.field">
                <th mat-header-cell *matHeaderCellDef 
                    cdkDrag 
                    cdkDragBoundary=".mat-header-row"
                    [style.width.px]="col.width"
                    class="resizable-header">
                    
                    <div class="header-container-inner">
                        <div class="header-top-row">
                            <div class="header-main-content" (click)="onSort($event, col)">
                                <span class="header-text">{{ col.header }}</span>
                                <mat-icon *ngIf="col.sortable && request.sortBy === col.field" 
                                          class="sort-icon" 
                                          [class.desc]="request.sortDirection === 'desc'">
                                    arrow_upward
                                </mat-icon>
                            </div>
                            <button mat-icon-button [matMenuTriggerFor]="columnMenu" class="menu-btn" (click)="$event.stopPropagation()">
                                <mat-icon>more_vert</mat-icon>
                            </button>
                        </div>

                        <div class="filter-row" (click)="$event.stopPropagation()">
                            <input class="column-filter-input" 
                                   [placeholder]="'Filter ' + col.header"
                                   (input)="onColumnFilter(col.field, $any($event.target).value)">
                        </div>
                    </div>

                    <span class="resize-handle" (mousedown)="startResize($event, col)"></span>
                    <div class="drag-placeholder" *cdkDragPlaceholder></div>
                </th>
                <td mat-cell *matCellDef="let row" [style.width.px]="col.width">
                    {{ col.cell ? col.cell(row) : row[col.field] }}
                </td>
            </ng-container>

            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="sticky-right actions-col">Actions</th>
                <td mat-cell *matCellDef="let row" class="sticky-right actions-col">
                    <div class="action-buttons">
                        <button mat-icon-button color="primary" (click)="edit.emit(row)" [disabled]="loading">
                            <mat-icon>edit</mat-icon>
                        </button>
                        <button mat-icon-button color="warn" (click)="delete.emit([row])" [disabled]="loading">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </div>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumnsWithActions(); sticky: true" class="header-row"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumnsWithActions()" class="clickable-row" (click)="onRowClick($event, row)"></tr>
        </table>
    </div>

    <mat-paginator [disabled]="loading" [length]="totalCount" [pageSize]="request.pageSize" [pageSizeOptions]="[5,10,20,50,100]" (page)="onPageChange($event)"></mat-paginator>
</div>

<mat-menu #columnMenu="matMenu">
    <div class="menu-header" style="padding: 10px; font-weight: bold; border-bottom: 1px solid #eee;">Columns Visibility</div>
    <mat-checkbox *ngFor="let col of columns" 
                  [checked]="col.visible" 
                  (change)="col.visible = $event.checked; updateDisplayedColumns()" 
                  class="column-toggle" 
                  style="display: block; padding: 5px 15px;"
                  (click)="$event.stopPropagation()">
        {{ col.header }}
    </mat-checkbox>
</mat-menu>