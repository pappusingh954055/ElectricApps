<div class="datagrid-container">

    <!-- ðŸ”„ LOADER -->
    <div class="grid-loader" *ngIf="loading">
        <mat-progress-spinner diameter="40" mode="indeterminate"></mat-progress-spinner>
    </div>

    <!-- ðŸ” SEARCH -->
    <mat-form-field appearance="outline" class="search-box">
        <mat-label>Search</mat-label>
        <input matInput (keyup)="onSearch($event.target.value)" />
    </mat-form-field>

    <!-- ðŸ“Š TABLE -->
    <table mat-table [dataSource]="data" class="server-datagrid">

        <!-- ================= SELECT ================= -->
        <ng-container matColumnDef="select">
            <th mat-header-cell *matHeaderCellDef class="sticky-left select-col">
                <mat-checkbox (change)="toggleAll($event)" [checked]="isHeaderChecked()">
                </mat-checkbox>
            </th>

            <td mat-cell *matCellDef="let row" class="sticky-left select-col">
                <mat-checkbox (change)="toggleRow(row)" [checked]="selection.has(row)">
                </mat-checkbox>
            </td>
        </ng-container>

        <!-- ================= DYNAMIC COLUMNS ================= -->
        <ng-container *ngFor="let col of visibleColumns" [matColumnDef]="col.field">

            <th mat-header-cell *matHeaderCellDef cdkDrag cdkDragBoundary=".server-datagrid"
                [cdkDragDisabled]="!col.visible" class="resizable-header" [style.width.px]="col.width"
                (mouseenter)="hoveredColumn = col.field" (mouseleave)="hoveredColumn = null">

                <!-- HEADER CONTENT (FIXED WIDTH) -->
                <div class="header-wrapper">

                    <div class="header-content" (click)="!loading && onSort(col)">

                        <span class="header-text">{{ col.header }}</span>

                        <!-- SORT ICON -->
                        <mat-icon *ngIf="col.sortable && hoveredColumn === col.field" class="sort-icon"
                            [class.asc]="request.sortBy === col.field && request.sortDirection === 'asc'"
                            [class.desc]="request.sortBy === col.field && request.sortDirection === 'desc'">
                            keyboard_arrow_up
                        </mat-icon>

                        <!-- FILTER / COLUMN TOGGLE -->
                        <button mat-icon-button class="filter-icon" [matMenuTriggerFor]="columnMenu"
                            (click)="$event.stopPropagation()">
                            <mat-icon>filter_alt</mat-icon>
                        </button>

                    </div>

                    <!-- RESIZE HANDLE -->
                    <span class="resize-handle" (mousedown)="startResize($event, col)">
                    </span>

                </div>

                <!-- DRAG PREVIEW -->
                <div *cdkDragPreview class="drag-preview">
                    {{ col.header }}
                </div>

                <!-- DRAG PLACEHOLDER -->
                <div *cdkDragPlaceholder class="drag-placeholder"></div>

            </th>

            <td mat-cell *matCellDef="let row" [style.width.px]="col.width">
                {{ col.cell ? col.cell(row) : row[col.field] }}
            </td>

        </ng-container>

        <!-- ================= ACTIONS ================= -->
        <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="sticky-right actions-col">
                Actions
            </th>

            <td mat-cell *matCellDef="let row" class="sticky-right actions-col">
                <button mat-icon-button color="primary" (click)="edit.emit(row)">
                    <mat-icon>edit</mat-icon>
                </button>

                <button mat-icon-button color="warn" (click)="delete.emit([row])">
                    <mat-icon>delete</mat-icon>
                </button>
            </td>
        </ng-container>

        <!-- ================= HEADER ROW ================= -->
        <tr mat-header-row *matHeaderRowDef="displayedColumnsWithActions(); sticky: true" cdkDropList
            cdkDropListOrientation="horizontal" cdkDropListLockAxis="x" (cdkDropListDropped)="dropColumn($event)"
            class="header-row">
        </tr>

        <!-- ================= DATA ROW ================= -->
        <tr mat-row *matRowDef="let row; columns: displayedColumnsWithActions()" class="clickable-row"
            (click)="onRowClick($event, row)">
        </tr>

    </table>

    <!-- ================= COLUMN TOGGLE MENU ================= -->
    <mat-menu #columnMenu="matMenu">
        <mat-checkbox *ngFor="let col of columns" [checked]="col.visible"
            (change)="col.visible = $event.checked; updateDisplayedColumns()" class="column-toggle">
            {{ col.header }}
        </mat-checkbox>
    </mat-menu>

    <!-- ðŸ“„ PAGINATION -->
    <mat-paginator [disabled]="loading" [length]="totalCount" [pageSize]="request.pageSize"
        [pageSizeOptions]="[5,10,20,50]" (page)="onPageChange($event)">
    </mat-paginator>

</div>