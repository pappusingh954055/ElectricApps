<div class="login-wrapper">
  <!-- <mat-progress-bar mode="indeterminate" *ngIf="loading"></mat-progress-bar> -->

  <mat-card class="login-card">
      <div class="login-header">
      <h2>{{ resetPasswordMode ? 'Reset Password' : (forgotPasswordMode ? 'Forgot Password' : (changePasswordMode ? 'Change Password' : 'Welcome Back')) }}</h2>
      <p>{{ resetPasswordMode ? 'Enter your new password' : (forgotPasswordMode ? 'Enter your email to receive a reset token' : (changePasswordMode ? 'Update your credentials' : 'Enter your credentials to access the portal')) }}</p>
    </div>

    <mat-card-content>
      <!-- LOGIN FORM -->
      <form [formGroup]="loginForm" (ngSubmit)="Login()" *ngIf="!changePasswordMode && !forgotPasswordMode && !resetPasswordMode">
        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Email</mat-label>
          <input matInput formControlName="Email" type="email" name="username" autocomplete="username" #emailInputField>
        </mat-form-field>

        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Password</mat-label>
          <input matInput type="password" formControlName="Password">
        </mat-form-field>

        <div class="form-options">
          <mat-checkbox formControlName="rememberMe" color="primary">Remember me</mat-checkbox>
          <div style="display: flex; gap: 10px; flex-direction: column; align-items: flex-end;">
             <a class="forgot-link" (click)="toggleChangePasswordMode()" style="cursor: pointer;">Change Password?</a>
             <a class="forgot-link" (click)="toggleForgotPasswordMode()" style="cursor: pointer;">Forgot Password?</a>
          </div>
        </div>

        <button mat-flat-button color="primary" class="login-btn" [disabled]="loading || loginForm.invalid">
          <span *ngIf="!loading">SIGN IN</span>
          <div class="loader-container" *ngIf="loading">
            <mat-spinner diameter="20" color="accent"></mat-spinner>
            <span>Signing in...</span>
          </div>
        </button>
      </form>

      <!-- FORGOT PASSWORD FORM -->
      <form [formGroup]="forgotPasswordForm" (ngSubmit)="onForgotPassword()" *ngIf="forgotPasswordMode">
        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Email</mat-label>
          <input matInput formControlName="Email" placeholder="Enter your registered email">
        </mat-form-field>

        <button mat-flat-button color="primary" class="login-btn" [disabled]="loading || forgotPasswordForm.invalid">
          <span *ngIf="!loading">SEND RESET LINK</span>
          <div class="loader-container" *ngIf="loading">
            <mat-spinner diameter="20" color="accent"></mat-spinner>
            <span>Sending...</span>
          </div>
        </button>

        <button type="button" mat-button color="accent" (click)="toggleForgotPasswordMode()" style="margin-top: 10px; width: 100%;">
          Back to Login
        </button>
      </form>

      <!-- RESET PASSWORD FORM -->
      <form [formGroup]="resetPasswordForm" (ngSubmit)="onResetPassword()" *ngIf="resetPasswordMode">
        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Email</mat-label>
          <input matInput formControlName="Email" readonly>
        </mat-form-field>

        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Reset Token</mat-label>
          <input matInput formControlName="ResetToken" placeholder="Paste token here">
        </mat-form-field>

        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>New Password</mat-label>
          <input matInput type="password" formControlName="NewPassword">
        </mat-form-field>

        <button mat-flat-button color="primary" class="login-btn" [disabled]="loading || resetPasswordForm.invalid">
          <span *ngIf="!loading">RESET PASSWORD</span>
          <div class="loader-container" *ngIf="loading">
            <mat-spinner diameter="20" color="accent"></mat-spinner>
            <span>Processing...</span>
          </div>
        </button>

        <button type="button" mat-button color="accent" (click)="cancelReset()" style="margin-top: 10px; width: 100%;">
          Cancel
        </button>
      </form>

      <!-- CHANGE PASSWORD FORM -->
      <form [formGroup]="changePasswordForm" (ngSubmit)="ChangePassword()" *ngIf="changePasswordMode">
        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Email</mat-label>
          <input matInput formControlName="Email">
        </mat-form-field>

        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Old Password</mat-label>
          <input matInput type="password" formControlName="OldPassword">
        </mat-form-field>

        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>New Password</mat-label>
          <input matInput type="password" formControlName="NewPassword">
        </mat-form-field>

        <button mat-flat-button color="primary" class="login-btn" [disabled]="loading || changePasswordForm.invalid">
          <span *ngIf="!loading">CHANGE PASSWORD</span>
          <div class="loader-container" *ngIf="loading">
            <mat-spinner diameter="20" color="accent"></mat-spinner>
            <span>Processing...</span>
          </div>
        </button>

        <button type="button" mat-button color="accent" (click)="toggleChangePasswordMode()" style="margin-top: 10px; width: 100%;">
          Back to Login
        </button>
      </form>
    </mat-card-content>
  </mat-card>
</div>