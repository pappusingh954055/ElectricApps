<div class="page-container p-4 flex-column" [class.disabled-content]="loading">
  <div class="header-row flex-row flex-between flex-center mb-4">
    <div class="title-section flex-row flex-center gap-2">
      <button mat-icon-button (click)="onCancel()" color="primary">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <h2 class="text-xl font-bold text-gray-800 m-0">{{ companyId ? 'Edit' : 'Add' }} Company</h2>
    </div>
  </div>

  <div class="form-container flex-1">
    <form [formGroup]="companyForm" class="flex-column gap-4">
      
      <!-- Section: General Info -->
      <mat-card class="section-card">
        <mat-card-header>
          <mat-icon mat-card-avatar color="primary">business</mat-icon>
          <mat-card-title>General Information</mat-card-title>
          <mat-card-subtitle>Basic details of the company</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content class="pt-4">
          <div class="flex-row flex-wrap gap-4">
            <!-- Logo Section -->
            <div class="logo-upload-container flex-column flex-center gap-2 pr-4 border-r">
              <div class="logo-preview-box" (click)="logoInput.click()">
                <img *ngIf="logoPreview || companyForm.get('logoUrl')?.value" 
                     [src]="getImgUrl(logoPreview || companyForm.get('logoUrl')?.value)" 
                     alt="Company Logo">
                <mat-icon *ngIf="!logoPreview && !companyForm.get('logoUrl')?.value">add_a_photo</mat-icon>
              </div>
              <button type="button" mat-stroked-button color="primary" (click)="logoInput.click()" class="btn-sm">
                {{ (logoPreview || companyForm.get('logoUrl')?.value) ? 'Change Logo' : 'Upload Logo' }}
              </button>
              <input #logoInput type="file" (change)="onLogoSelected($event)" accept="image/*" style="display: none;">
            </div>

            <div class="flex-1 flex-column gap-2">
              <div class="flex-row flex-wrap gap-4">
                <mat-form-field appearance="outline" class="flex-grow-1 min-w-300">
                  <mat-label>Company Name</mat-label>
                  <input matInput formControlName="name">
                  <mat-icon matSuffix>corporate_fare</mat-icon>
                  <mat-error *ngIf="companyForm.get('name')?.hasError('required')">Required</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="flex-grow-1 min-w-300">
                  <mat-label>Tagline</mat-label>
                  <input matInput formControlName="tagline">
                  <mat-icon matSuffix>auto_fix_high</mat-icon>
                </mat-form-field>
              </div>
              
              <div class="flex-row flex-wrap gap-4">
                <mat-form-field appearance="outline" class="flex-grow-1 min-w-300">
                  <mat-label>GSTIN</mat-label>
                  <input matInput formControlName="gstin">
                  <mat-icon matSuffix>receipt</mat-icon>
                  <mat-error *ngIf="companyForm.get('gstin')?.hasError('pattern')">Invalid Format</mat-error>
                </mat-form-field>
              </div>
            </div>
          </div>


          <div class="flex-row flex-wrap gap-4 mt-2">
            <mat-form-field appearance="outline" class="flex-grow-1 min-w-200">
              <mat-label>Email</mat-label>
              <input matInput formControlName="primaryEmail">
              <mat-icon matSuffix>email</mat-icon>
              <mat-error *ngIf="companyForm.get('primaryEmail')?.hasError('email')">Invalid Email</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="flex-grow-1 min-w-200">
              <mat-label>Phone</mat-label>
              <input matInput formControlName="primaryPhone">
              <mat-icon matSuffix>phone</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="flex-grow-1 min-w-200">
              <mat-label>Registration No.</mat-label>
              <input matInput formControlName="registrationNumber">
              <mat-icon matSuffix>app_registration</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="flex-grow-1 min-w-200">
              <mat-label>Website</mat-label>
              <input matInput formControlName="website">
              <mat-icon matSuffix>language</mat-icon>
            </mat-form-field>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Section: Address -->
      <mat-card class="section-card" formGroupName="address">
        <mat-card-header>
          <mat-icon mat-card-avatar color="primary">location_on</mat-icon>
          <mat-card-title>Address Details</mat-card-title>
          <mat-card-subtitle>Registered office location</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content class="pt-4">
          <div class="flex-column gap-2">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Address Line 1</mat-label>
              <input matInput formControlName="addressLine1">
            </mat-form-field>

            <div class="flex-row flex-wrap gap-4">
              <mat-form-field appearance="outline" class="flex-grow-1 min-w-200">
                <mat-label>Address Line 2 (Optional)</mat-label>
                <input matInput formControlName="addressLine2">
              </mat-form-field>
            </div>

            <div class="flex-row flex-wrap gap-4">
              <mat-form-field appearance="outline" class="flex-grow-1 min-w-200">
                <mat-label>City</mat-label>
                <input matInput formControlName="city">
              </mat-form-field>

              <mat-form-field appearance="outline" class="flex-grow-1 min-w-200">
                <mat-label>State</mat-label>
                <input matInput formControlName="state">
              </mat-form-field>

              <mat-form-field appearance="outline" class="flex-grow-1 min-w-100">
                <mat-label>State Code</mat-label>
                <input matInput formControlName="stateCode">
                <mat-hint>e.g., 07</mat-hint>
              </mat-form-field>

              <mat-form-field appearance="outline" class="flex-grow-1 min-w-200">
                <mat-label>Pin Code</mat-label>
                <input matInput formControlName="pinCode">
                <mat-error *ngIf="companyForm.get('address.pinCode')?.hasError('pattern')">6 Digits required</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" class="flex-grow-1 min-w-200">
                <mat-label>Country</mat-label>
                <mat-select formControlName="country">
                  <mat-option value="India">India</mat-option>
                  <mat-option value="USA">USA</mat-option>
                  <mat-option value="UK">UK</mat-option>
                  <mat-option value="UAE">UAE</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Section: Bank Info -->
      <mat-card class="section-card" formGroupName="bankInfo">
        <mat-card-header>
          <mat-icon mat-card-avatar color="primary">account_balance</mat-icon>
          <mat-card-title>Bank Account Details</mat-card-title>
          <mat-card-subtitle>For billing and payments</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content class="pt-4">
          <div class="flex-row flex-wrap gap-4">
            <mat-form-field appearance="outline" class="flex-grow-1 min-w-250">
              <mat-label>Bank Name</mat-label>
              <input matInput formControlName="bankName">
            </mat-form-field>

            <mat-form-field appearance="outline" class="flex-grow-1 min-w-250">
              <mat-label>Branch Name</mat-label>
              <input matInput formControlName="branchName">
            </mat-form-field>

            <mat-form-field appearance="outline" class="flex-grow-1 min-w-250">
              <mat-label>Account Number</mat-label>
              <input matInput formControlName="accountNumber">
            </mat-form-field>

            <mat-form-field appearance="outline" class="flex-grow-1 min-w-200">
              <mat-label>IFSC Code</mat-label>
              <input matInput formControlName="ifscCode">
            </mat-form-field>

            <mat-form-field appearance="outline" class="flex-grow-1 min-w-200">
              <mat-label>Account Type</mat-label>
              <mat-select formControlName="accountType">
                <mat-option value="Current">Current</mat-option>
                <mat-option value="Savings">Savings</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Section: Authorized Signatories -->
      <mat-card class="section-card">
        <mat-card-header>
          <mat-icon mat-card-avatar color="primary">assignment_ind</mat-icon>
          <div class="flex-column">
            <mat-card-title>Authorized Signatories</mat-card-title>
            <mat-card-subtitle>People authorized to sign documents</mat-card-subtitle>
          </div>
          <span class="flex-1"></span>
          <button type="button" mat-stroked-button color="primary" (click)="addSignatory()" class="btn-sm">
            <mat-icon>add</mat-icon> Add Signatory
          </button>
        </mat-card-header>
        <mat-card-content class="pt-4">
          <div formArrayName="authorizedSignatories" class="flex-column gap-3">
            <div *ngFor="let sig of signatories.controls; let i=index" [formGroupName]="i" 
                 class="signatory-row p-3 border rounded flex-row flex-center gap-3">
              
              <!-- Signature Preview/Upload -->
              <div class="sig-upload-box flex-column flex-center gap-1" (click)="sigInput.click()">
                <div class="sig-preview">
                  <img *ngIf="sig.get('signatureImageUrl')?.value" 
                       [src]="getImgUrl(sig.get('signatureImageUrl')?.value)" alt="Signature">
                  <mat-icon *ngIf="!sig.get('signatureImageUrl')?.value">draw</mat-icon>
                </div>
                <input #sigInput type="file" (change)="onSignatureSelected($event, i)" accept="image/*" style="display: none;">
                <span class="text-xs text-blue-600">Signature</span>
              </div>

              <mat-form-field appearance="outline" class="flex-1">
                <mat-label>Person Name</mat-label>
                <input matInput formControlName="personName">
              </mat-form-field>

              <mat-form-field appearance="outline" class="flex-1">
                <mat-label>Designation</mat-label>
                <input matInput formControlName="designation">
              </mat-form-field>

              <div class="flex-column flex-center px-2">
                <mat-slide-toggle formControlName="isDefault" color="primary">
                  {{ sig.get('isDefault')?.value ? 'Default' : 'Regular' }}
                </mat-slide-toggle>
              </div>

              <button type="button" mat-icon-button color="warn" (click)="removeSignatory(i)">
                <mat-icon>delete_outline</mat-icon>
              </button>
            </div>


            <div *ngIf="signatories.length === 0" class="empty-state p-4 text-center text-gray-400">
              No signatories added. Click the button above to add.
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Footer -->

      <form-footer 
        [loading]="loading" 
        [saveLabel]="companyId ? 'Update Company' : 'Create Company'" 
        (save)="onSave()" 
        (cancel)="onCancel()">
      </form-footer>

    </form>
  </div>
</div>
