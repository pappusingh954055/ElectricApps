<mat-card class="product-card shadow-sm">
  <div class="product-header">
    <h2 class="m-0 text-primary fw-bold" style="font-size: 1.2rem;">{{ isEditMode ? 'Edit' : 'Add' }} Product</h2>
    
    <div class="actions">
      <!-- File Info -->
      <span *ngIf="selectedFileName" style="font-size: 0.9em; color: #666; margin-right: 12px;">
        {{ selectedFileName }}
      </span>

      <!-- Download Template -->
      <button mat-stroked-button color="primary" (click)="downloadTemplate()" *ngIf="!isEditMode">
        <mat-icon>download</mat-icon> Template
      </button>

      <!-- Upload Excel Trigger -->
      <button mat-stroked-button color="primary" (click)="fileInput.click()" *ngIf="!selectedFileName && !isEditMode">
        <mat-icon>cloud_upload</mat-icon> Upload Excel
      </button>

      <!-- Hidden Input -->
      <input #fileInput type="file" (change)="onFileSelected($event)" style="display: none;" accept=".xlsx, .xls, .csv">

      <!-- Upload Actions (Visible when file selected) -->
      <button mat-raised-button class="submit-btn" *ngIf="selectedFileName" (click)="uploadExcel()">
        <mat-icon>save</mat-icon> Batch Save
      </button>

      <!-- Normal Save -->
      <button mat-raised-button class="submit-btn" (click)="onSave()" [disabled]="loading" *ngIf="!selectedFileName">
        <mat-icon>save</mat-icon> {{ isEditMode ? 'Update' : 'Save' }}
      </button>

      <button mat-raised-button class="cancel-btn" (click)="onCancel()" *ngIf="!selectedFileName">
        <mat-icon>close</mat-icon> Cancel
      </button>

      <button mat-icon-button class="cancel-btn" *ngIf="selectedFileName" (click)="resetFile(fileInput)" matTooltip="Reset File">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>

  <mat-card-content class="pt-3">
    <form [formGroup]="productsForm" class="form-grid">

      <!-- ðŸ” Category Autocomplete -->
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Category *</mat-label>
        <input type="text"
               placeholder="Search Category"
               matInput
               formControlName="categorySearch"
               [matAutocomplete]="autoCat">
        <mat-autocomplete #autoCat="matAutocomplete" [displayWith]="displayCategoryFn" (optionSelected)="onCategorySelected($event)">
          <mat-option *ngFor="let c of filteredCategories | async" [value]="c">
            <span class="fw-bold">[{{ c.categoryCode }}]</span> - {{ c.name }}
          </mat-option>
        </mat-autocomplete>
        <div matSuffix *ngIf="isSearchingCategories || (loading && !isEditMode)" class="input-spinner">
          <mat-spinner diameter="18"></mat-spinner>
        </div>
        <mat-error *ngIf="productsForm.get('categorySearch')?.hasError('required')">
          Category is required
        </mat-error>
      </mat-form-field>

      <!-- ðŸ” Subcategory Autocomplete -->
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Subcategory *</mat-label>
        <input type="text"
               placeholder="Search Subcategory"
               matInput
               formControlName="subcategorySearch"
               [matAutocomplete]="autoSub">
        <mat-autocomplete #autoSub="matAutocomplete" [displayWith]="displaySubcategoryFn" (optionSelected)="onSubcategorySelected($event)">
          <mat-option *ngFor="let s of filteredSubcategories | async" [value]="s">
             {{ s.subcategoryName }}
          </mat-option>
        </mat-autocomplete>
        <div matSuffix *ngIf="isSearchingSubcategories || loading" class="input-spinner">
          <mat-spinner diameter="18"></mat-spinner>
        </div>
        <mat-error *ngIf="productsForm.get('subcategorySearch')?.hasError('required')">
          Subcategory is required
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Product Name *</mat-label>
        <input matInput formControlName="productName" placeholder="e.g. Dell Latitude 5420">
        <mat-error *ngIf="productsForm.get('productName')?.hasError('required')">
          Product name is required
        </mat-error>
        <mat-error *ngIf="productsForm.get('productName')?.hasError('maxlength')">
          Exceeds 30 characters limit
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>SKU (Product Code)</mat-label>
        <input matInput formControlName="sku" placeholder="e.g. PROD-001">
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Brand</mat-label>
        <input matInput formControlName="brand" placeholder="e.g. Dell / HP">
        <mat-error *ngIf="productsForm.get('brand')?.hasError('maxlength')">
          Exceeds 30 characters limit
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Unit(UOM) *</mat-label>
        <input type="text"
               placeholder="Search Unit"
               matInput
               formControlName="unit"
               [matAutocomplete]="autoUnit">
        <mat-autocomplete #autoUnit="matAutocomplete">
          <mat-option *ngFor="let u of filteredUnits | async" [value]="u">
            {{ u }}
          </mat-option>
        </mat-autocomplete>
        <div matSuffix *ngIf="isSearchingUnits" class="input-spinner">
          <mat-spinner diameter="18"></mat-spinner>
        </div>
        <mat-error *ngIf="productsForm.get('unit')?.hasError('required')">
          Unit is required
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Base Purchase Price *</mat-label>
        <input matInput type="number" formControlName="basePurchasePrice" placeholder="0.00">
        <span matPrefix>&nbsp;â‚¹&nbsp;</span>
        <mat-error *ngIf="productsForm.get('basePurchasePrice')?.hasError('required')">
          Price is required
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>MRP(Maximum Retail Price)</mat-label>
        <input matInput type="number" formControlName="mrp" placeholder="0.00">
        <span matPrefix>&nbsp;â‚¹&nbsp;</span>
      </mat-form-field>
      
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Sale Rate</mat-label>
        <input matInput type="number" formControlName="saleRate" placeholder="0.00">
        <span matPrefix>&nbsp;â‚¹&nbsp;</span>
      </mat-form-field>
      
      <mat-form-field appearance="outline">
        <mat-label>GST % *</mat-label>
        <mat-select formControlName="defaultGst">
          <mat-option [value]="0">0% (Exempted)</mat-option>
          <mat-option [value]="5">5%</mat-option>
          <mat-option [value]="12">12%</mat-option>
          <mat-option [value]="18">18%</mat-option>
          <mat-option [value]="28">28%</mat-option>
        </mat-select>
        <mat-error *ngIf="productsForm.get('defaultGst')?.hasError('required')">
          GST is required
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>HSN Code</mat-label>
        <input matInput formControlName="hsnCode" placeholder="8-digit code">
      </mat-form-field>

      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Minimum Stock (Re-order Level)</mat-label>
        <input matInput type="number" formControlName="minStock" placeholder="Alert level">
      </mat-form-field>

      <div class="toggle-group d-flex gap-3 align-items-center">
        <mat-slide-toggle formControlName="trackInventory" color="primary">
          <span style="font-size: 0.85rem;">Track Inventory</span>
        </mat-slide-toggle>
        
        <mat-slide-toggle formControlName="isActive" color="primary">
          <span style="font-size: 0.85rem;">Active</span>
        </mat-slide-toggle>
      </div>

      <mat-form-field appearance="outline">
        <mat-label>Product Type *</mat-label>
        <mat-select formControlName="productType">
          <mat-option [value]="1">Finished</mat-option>
          <mat-option [value]="2">Goods</mat-option>
          <mat-option [value]="3">Raw Material</mat-option>
        </mat-select>
        <mat-error *ngIf="productsForm.get('productType')?.hasError('required')">
          Type is required
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Damaged Stock</mat-label>
        <input matInput type="number" formControlName="damagedStock" placeholder="0">
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width" subscriptSizing="dynamic">
        <mat-label>Description</mat-label>
        <textarea matInput rows="1" formControlName="description" placeholder="Technical specifications..."></textarea>
      </mat-form-field>

    </form>
  </mat-card-content>
</mat-card>