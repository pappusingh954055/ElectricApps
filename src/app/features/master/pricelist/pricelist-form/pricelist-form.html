<div [formGroup]="priceListForm" class="master-container">
  <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid #eee; background: #fff; margin-bottom: 16px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
    <h2 class="m-0 text-primary fw-bold" style="font-size: 1.2rem;">{{ isEditMode ? 'Edit' : 'Add' }} Price List</h2>
    
    <div style="display: flex; align-items: center; gap: 12px;">
      <button mat-raised-button color="primary" (click)="onSave()" [disabled]="loading || priceListForm.invalid">
        <mat-icon *ngIf="!loading">save</mat-icon> 
        <mat-spinner *ngIf="loading" diameter="18" style="display: inline-block; margin-right: 8px;"></mat-spinner>
        {{ isEditMode ? 'Update' : 'Save' }}
      </button>

      <button mat-stroked-button color="warn" (click)="onCancel()">
        <mat-icon>close</mat-icon> Cancel
      </button>
    </div>
  </div>
  <div class="header-form-card">
    <div class="header-grid">
      <mat-form-field appearance="outline"><mat-label>Price List Name</mat-label><input matInput formControlName="name"></mat-form-field>
      
      <mat-form-field appearance="outline"><mat-label>Price Type</mat-label>
        <mat-select formControlName="priceType">
          <mat-option value="SALES">Sales</mat-option>
          <mat-option value="PURCHASE">Purchase</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Apply to Group</mat-label>
        <mat-select formControlName="applicableGroup">
          <mat-option *ngFor="let group of applicableGroups" [value]="group.value">
            {{ group.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline"><mat-label>Price List Code</mat-label><input matInput formControlName="code"></mat-form-field>

      <mat-form-field appearance="outline"><mat-label>Valid From</mat-label>
        <input matInput [matDatepicker]="p1" formControlName="validFrom">
        <mat-datepicker-toggle matSuffix [for]="p1"></mat-datepicker-toggle>
        <mat-datepicker #p1></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline"><mat-label>Valid To</mat-label>
        <input matInput [matDatepicker]="p2" formControlName="validTo">
        <mat-datepicker-toggle matSuffix [for]="p2"></mat-datepicker-toggle>
        <mat-datepicker #p2></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline"><mat-label>Currency</mat-label>
        <mat-select formControlName="currency"><mat-option value="INR">INR</mat-option></mat-select>
      </mat-form-field>

      <div class="toggle-box">
        <mat-slide-toggle color="primary" formControlName="isActive">Active Status</mat-slide-toggle>
      </div>

      <mat-form-field appearance="outline" class="description-field">
        <mat-label>Price List Description / Remarks</mat-label>
        <textarea matInput formControlName="description" rows="1"></textarea>
      </mat-form-field>
    </div>
  </div>

  <div class="table-section-card">
    <div class="p-3 border-bottom d-flex align-items-center bg-light mb-4 flex-wrap gap-3">
      <!-- Desktop Spacer -->
      <div class="d-none d-md-block" style="flex: 1;"></div>

      <!-- Title in Center -->
      <h6 class="m-0 fw-bold d-flex align-items-center justify-content-center flex-grow-1 flex-md-grow-0" style="white-space: nowrap; margin-top: -4px; min-width: 200px;">
        <mat-icon class="text-primary" style="margin-right: 8px;">inventory_2</mat-icon> 
        <span>Linked Products</span>
      </h6>
      
      <!-- Buttons on Right / Center on Mobile -->
      <div class="d-flex gap-3 justify-content-center justify-content-md-end" style="flex: 1; min-width: 200px;">
        <button type="button" mat-stroked-button color="primary" class="btn-sm-responsive" style="margin-right: 15px;" (click)="openBulkAddDialog()">
          <mat-icon>list_alt</mat-icon> <span class="d-none d-sm-inline">Bulk </span>Add
        </button>        
        <button type="button" mat-flat-button class="add-item-btn btn-sm-responsive" (click)="addItemRow()">
          <mat-icon>add</mat-icon> Add<span class="d-none d-sm-inline"> Product</span>
        </button>        
      </div>
    </div>
    
    <!-- Extra Spacer to prevent sticking -->
    <div style="height: 25px;"></div>

    <div formArrayName="priceListItems" class="table-responsive-box">
      <table class="enterprise-table">
        <thead>
          <tr>
            <th class="col-search">PRODUCT DETAILS</th>
            <th class="col-uom">UNIT</th>
            <th class="col-min">MIN QTY</th>
            <th class="col-max">MAX QTY</th>
            <th class="col-price">RATE (â‚¹)</th>
            <th class="col-disc">DISC (%)</th>
            <th class="col-action">ACTION</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of items.controls; let i = index" [formGroupName]="i">
            <td class="col-search">
              <mat-form-field appearance="outline" class="w-100 no-subscript">
                <input type="text" matInput placeholder="Search..." formControlName="productSearch" [matAutocomplete]="auto">
                <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn" (optionSelected)="onProductSelect($event, i)">
                  <mat-option *ngFor="let prod of filteredProducts[i]" [value]="prod">{{prod.name}}</mat-option>
                </mat-autocomplete>
              </mat-form-field>
            </td>
            <td class="col-uom"><input type="text" class="table-control text-center" formControlName="unit" readonly></td>
            <td class="col-min"><input type="number" class="table-control text-center" formControlName="minQty"></td>
            <td class="col-max"><input type="number" class="table-control text-center" formControlName="maxQty"></td>
            <td class="col-price"><input type="number" class="table-control text-end text-success fw-bold" formControlName="rate"></td>
            <td class="col-disc"><input type="number" class="table-control text-center" formControlName="discountPercent"></td>
            <td class="col-action">
              <button type="button" mat-icon-button color="warn" (click)="removeItem(i)" [disabled]="items.length === 1">
                <mat-icon>delete_outline</mat-icon>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>