
<div class="datagrid-container">
  <div class="grid-loader" *ngIf="loading">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <div class="table-wrapper">
    <table mat-table [dataSource]="dataSource" multiTemplateDataRows class="server-datagrid" matSort (matSortChange)="onSortChange($event)">

      <!-- Checkbox Column -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef class="sticky-left select-col">
          <mat-checkbox (change)="$event ? masterToggle() : null"
                        [checked]="selection.hasValue() && isAllSelected()"
                        [indeterminate]="selection.hasValue() && !isAllSelected()">
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row" class="sticky-left select-col">
          <mat-checkbox (click)="$event.stopPropagation()"
                        (change)="$event ? selection.toggle(row) : null"
                        [checked]="selection.isSelected(row)">
          </mat-checkbox>
        </td>
      </ng-container>

      <!-- Dynamic Columns -->
      <ng-container *ngFor="let col of columns" [matColumnDef]="col.field">
        <th mat-header-cell *matHeaderCellDef mat-sort-header [style.width.px]="col.width">
            {{ col.header }}
        </th>
        <td mat-cell *matCellDef="let row">
            <ng-container *ngIf="col.cell; else defaultCell">
              {{ col.cell(row) }}
            </ng-container>
            <ng-template #defaultCell>
              {{ row[col.field] }}
            </ng-template>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="sticky-right actions-col">Actions</th>
        <td mat-cell *matCellDef="let row" class="sticky-right actions-col">
            <button mat-icon-button (click)="editAction.emit(row); $event.stopPropagation()">
                <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="delete.emit(row); $event.stopPropagation()">
                <mat-icon>delete</mat-icon>
            </button>
        </td>
      </ng-container>

      <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
      <ng-container matColumnDef="expandedDetail">
        <td mat-cell *matCellDef="let element" [attr.colspan]="displayedColumns.length">
          <div class="element-detail"
               [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'">
             
             <!-- Child Table or Content -->
             <div class="detail-inner">
                <table mat-table [dataSource]="element.items" class="child-table" *ngIf="element.items && element.items.length">
                    <ng-container *ngFor="let childCol of childColumns" [matColumnDef]="childCol.field">
                        <th mat-header-cell *matHeaderCellDef> {{childCol.header}} </th>
                        <td mat-cell *matCellDef="let child"> 
                            <ng-container *ngIf="childCol.cell; else defaultChild">
                                {{ childCol.cell(child) }}
                            </ng-container>
                            <ng-template #defaultChild>
                                {{ child[childCol.field] }}
                            </ng-template>
                        </td>
                    </ng-container>

                    <!-- Add delete action for child if needed -->
                    <ng-container matColumnDef="childActions">
                        <th mat-header-cell *matHeaderCellDef>Action</th>
                        <td mat-cell *matCellDef="let child">
                             <button mat-icon-button color="warn" (click)="deleteChildRow.emit({parent: element, child: child})">
                                <mat-icon>delete</mat-icon>
                             </button>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="childDisplayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: childDisplayedColumns"></tr>
                </table>
                <div *ngIf="!element.items || element.items.length === 0" class="no-child-data">
                    No items available
                </div>
             </div>

          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
      <tr mat-row *matRowDef="let element; columns: displayedColumns;"
          class="element-row"
          [class.expanded-row]="expandedElement === element"
          (click)="toggleExpand(element)">
      </tr>
      <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>
    </table>
  </div>

  <mat-paginator [length]="totalCount" [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons
                 (page)="onPageChange($event)">
  </mat-paginator>
</div>
