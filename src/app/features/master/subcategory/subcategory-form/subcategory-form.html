<mat-card class="professional-form-card">
  <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid #eee;">
    <h2 class="m-0 text-primary fw-bold" style="font-size: 1.2rem;">{{ isEditMode ? 'Edit' : 'Add' }} Subcategory</h2>
    
    <div style="display: flex; align-items: center; gap: 12px;">
      <!-- File Info -->
      <span *ngIf="selectedFileName" style="font-size: 0.9em; color: #666;">
        {{ selectedFileName }}
      </span>
      
      <!-- Download Template -->
      <button mat-stroked-button color="primary" (click)="downloadTemplate()">
        <mat-icon>download</mat-icon> Download Template
      </button>

      <!-- Upload Excel Trigger -->
      <button mat-stroked-button color="primary" (click)="fileInput.click()" *ngIf="!selectedFileName">
        <mat-icon>cloud_upload</mat-icon> Upload Excel
      </button>

      <!-- Hidden Input -->
      <input #fileInput type="file" (change)="onFileSelected($event)" style="display: none;" accept=".xlsx, .xls, .csv">

      <!-- Upload Actions (Visible when file selected) -->
      <button mat-raised-button color="accent" *ngIf="selectedFileName" (click)="uploadExcel()">
        <mat-icon>save</mat-icon> Save
      </button>

      <button mat-icon-button color="warn" *ngIf="selectedFileName" (click)="resetFile(fileInput)" matTooltip="Reset File">
        <mat-icon>close</mat-icon>
      </button>

      <!-- Cancel Button (Header) -->
      <button mat-stroked-button color="warn" (click)="onCancel()">
        <mat-icon>close</mat-icon> Cancel
      </button>
    </div>
  </div>

  <mat-card-content *ngIf="!selectedFileName" class="mt-3">
    <form [formGroup]="subcategoryForm" class="form-grid">

      <mat-form-field appearance="outline">
        <mat-label>Code</mat-label>
        <input matInput formControlName="subcategoryCode">
      </mat-form-field>

      <mat-form-field appearance="outline" class="category-search-field">
        <mat-label>Category *</mat-label>
        <input type="text"
               placeholder="Search Category"
               matInput
               formControlName="categorySearch"
               [matAutocomplete]="auto">
        <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayCategoryFn" (optionSelected)="onCategorySelected($event)">
          <mat-option *ngFor="let c of filteredCategories | async" [value]="c">
            <span class="fw-bold">[{{ c.categoryCode }}]</span> - {{ c.categoryName }}
          </mat-option>
        </mat-autocomplete>
        
        <div matSuffix *ngIf="isSearchingCategories || loading" class="input-spinner">
          <mat-spinner diameter="18"></mat-spinner>
        </div>

        <mat-error *ngIf="subcategoryForm.get('categoryId')?.hasError('required')">Category is required</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Subcategory Name *</mat-label>
        <input matInput formControlName="subcategoryName">
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Default GST %</mat-label>
        <input matInput type="number" formControlName="defaultGst">
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Description</mat-label>
        <textarea matInput rows="3" formControlName="description"></textarea>
      </mat-form-field>

      <mat-slide-toggle formControlName="isActive">
        Active
      </mat-slide-toggle>

    </form>
  </mat-card-content>

  <!-- âœ… FOOTER -->
  <form-footer *ngIf="!selectedFileName" [loading]="loading" [saveLabel]="isEditMode ? 'Update' : 'Save'" (save)="onSave()" (cancel)="onCancel()">
  </form-footer>
</mat-card>