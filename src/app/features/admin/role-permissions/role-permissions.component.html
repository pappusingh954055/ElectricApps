<div class="page-container">
  <div class="header-section">
    <div class="title-group">
      <h1>Role Permissions Management</h1>
      <p class="subtitle">Search, filter, and manage permissions for each role efficiently.</p>
    </div>
    
    <div class="controls-group">
      <mat-form-field appearance="outline" class="role-select">
        <mat-label>Select Role</mat-label>
        <mat-select [(ngModel)]="selectedRoleId" (selectionChange)="onRoleChange()">
          <mat-option *ngFor="let role of roles" [value]="role.id">{{role.roleName}}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </div>

  <div class="content-card mat-elevation-z8" *ngIf="selectedRoleId; else noRoleSelected">
    
    <div class="table-toolbar">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Search Menu</mat-label>
        <mat-icon matPrefix>search</mat-icon>
        <input matInput (keyup)="applyFilter($event)" placeholder="Type menu name..." #input>
      </mat-form-field>

      <div class="actions-group">
        <button mat-stroked-button color="warn" (click)="resetPermissions()" style="margin-right: 12px;">
            <mat-icon>restart_alt</mat-icon> Reset
        </button>
        <button mat-raised-button color="primary" (click)="savePermissions()">
            <mat-icon>save</mat-icon> Save Changes
        </button>
      </div>
    </div>

    <!-- CLEAN TABLE GRID STRUCTURE -->
    <div class="table-container flat-tree-grid">
      
      <!-- HEADER WITH FIXED ALIGNMENT -->
      <div class="sticky-header grid-row header-row">
        <div class="cell menu-col">Menu Item</div>
        <div class="cell checkbox-col view">View</div>
        <div class="cell checkbox-col add">Add</div>
        <div class="cell checkbox-col edit">Edit</div>
        <div class="cell checkbox-col delete">Delete</div>
      </div>

      <mat-tree [dataSource]="dataSource" [treeControl]="treeControl">
        
        <!-- Flat Node Template -->
        <mat-tree-node *matTreeNodeDef="let node" class="grid-row node-row" [class.parent-node]="node.expandable">
          
          <!-- Menu Column with Level-based Indentation -->
          <div class="cell menu-col" [style.padding-left.px]="node.level * 32">
            <button mat-icon-button *ngIf="node.expandable" matTreeNodeToggle class="toggle-btn">
              <mat-icon>{{treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right'}}</mat-icon>
            </button>
            <span *ngIf="!node.expandable" class="spacer-btn"></span>
            
            <mat-icon class="menu-icon">{{node.icon || (node.expandable ? 'folder' : 'description')}}</mat-icon>
            <span class="node-title">{{node.title}}</span>
          </div>

          <!-- CHECKBOX COLUMNS - PERFECTLY ALIGNED -->
          <div class="cell checkbox-col">
            <mat-checkbox [(ngModel)]="getPermission(node.id).canView" 
                          (change)="node.expandable ? toggleNode(node, 'canView', $event.checked) : null"
                          color="primary"></mat-checkbox>
          </div>
          <div class="cell checkbox-col">
            <mat-checkbox [(ngModel)]="getPermission(node.id).canAdd" 
                          (change)="node.expandable ? toggleNode(node, 'canAdd', $event.checked) : null"
                          color="accent"></mat-checkbox>
          </div>
          <div class="cell checkbox-col">
            <mat-checkbox [(ngModel)]="getPermission(node.id).canEdit" 
                          (change)="node.expandable ? toggleNode(node, 'canEdit', $event.checked) : null"
                          color="accent"></mat-checkbox>
          </div>
          <div class="cell checkbox-col">
            <mat-checkbox [(ngModel)]="getPermission(node.id).canDelete" 
                          (change)="node.expandable ? toggleNode(node, 'canDelete', $event.checked) : null"
                          color="warn"></mat-checkbox>
          </div>
          
        </mat-tree-node>
      </mat-tree>
    </div>

    <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]" showFirstLastButtons></mat-paginator>
  </div>

  <ng-template #noRoleSelected>
    <div class="empty-state">
      <mat-icon class="empty-icon">admin_panel_settings</mat-icon>
      <h3>Select a Role to Manage Permissions</h3>
      <p>Choose a role from the dropdown above to view, filter, and edit access rights efficiently.</p>
    </div>
  </ng-template>
</div>
