<div class="container">
    <mat-card class="wrapper">
        <mat-card-header>
            <button mat-icon-button (click)="goBack()" class="back-button" matTooltip="Back to List">
                <mat-icon>arrow_back</mat-icon>
            </button>
            <div mat-card-avatar class="header-image-out">
                <mat-icon>{{isEditMode ? 'edit_note' : 'local_shipping'}}</mat-icon>
            </div>
            <mat-card-title>{{isEditMode ? 'EDIT OUTWARD GATE PASS' : 'OUTWARD GATE PASS ENTRY'}}</mat-card-title>
            <mat-card-subtitle>{{currentPassNo}}</mat-card-subtitle>
        </mat-card-header>
        
        <mat-card-content>
            <form [formGroup]="gatePassForm" class="form-grid">
                
                <!-- Section 1: Reference Details -->
                <div class="section-title">1. Reference Details</div>
                <div class="row">
                    <mat-form-field appearance="outline">
                        <mat-label>Reference Type</mat-label>
                        <mat-select formControlName="referenceType" [disabled]="isRedirected">
                            <mat-option *ngFor="let ref of referenceTypes" [value]="ref.id">{{ref.name}}</mat-option>
                        </mat-select>
                    </mat-form-field>
                    
                    <mat-form-field appearance="outline" *ngIf="gatePassForm.get('referenceType')?.value === 3 && !isRedirected">
                        <mat-label>Select Sale Order</mat-label>
                        <mat-select (selectionChange)="onSOSelected($event.value)">
                            <mat-option *ngFor="let so of availableSOs" [value]="so.id">
                                {{so.soNumber}} - {{so.customerName}}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>

                    <mat-form-field appearance="outline" *ngIf="gatePassForm.get('referenceType')?.value === 2 && !isRedirected">
                        <mat-label>Select Purchase Return</mat-label>
                        <mat-select (selectionChange)="onPRSelected($event.value)">
                            <mat-option *ngFor="let pr of availablePRs" [value]="pr.id">
                                {{pr.returnNumber}} - {{pr.supplierName}}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>

                    <mat-form-field appearance="outline" *ngIf="(gatePassForm.get('referenceType')?.value !== 3 && gatePassForm.get('referenceType')?.value !== 2) || isRedirected">
                        <mat-label>Reference No</mat-label>
                        <input matInput formControlName="referenceNo" placeholder="Enter Ref No" [readonly]="isRedirected">
                    </mat-form-field>
                    
                    <mat-form-field appearance="outline">
                        <mat-label>Party / Customer Name</mat-label>
                        <input matInput formControlName="partyName" placeholder="Auto-filled from Reference" [readonly]="isRedirected">
                    </mat-form-field>
                </div>
                
                <!-- Section 2: Transport & Driver Info -->
                <div class="section-title">2. Transport & Driver Info</div>
                <div class="row">
                    <mat-form-field appearance="outline">
                        <mat-label>Vehicle No</mat-label>
                        <input matInput formControlName="vehicleNo" placeholder="DL-01-AB-1234" required>
                        <mat-hint>Format: AA-00-AA-0000</mat-hint>
                        <mat-error *ngIf="gatePassForm.get('vehicleNo')?.hasError('pattern')">Invalid Format (Ex: MH-12-AB-1234)</mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>Vehicle Type</mat-label>
                        <mat-select formControlName="vehicleType">
                            <mat-option *ngFor="let v of vehicleTypes" [value]="v">{{v}}</mat-option>
                        </mat-select>
                    </mat-form-field>
                    
                    <mat-form-field appearance="outline">
                        <mat-label>Driver Name</mat-label>
                        <input matInput formControlName="driverName" placeholder="Driver Name" required>
                    </mat-form-field>
                    
                    <mat-form-field appearance="outline">
                        <mat-label>Driver Phone</mat-label>
                        <input matInput formControlName="driverPhone" placeholder="10 Digit Mobile" required>
                    </mat-form-field>
                    
                    <mat-form-field appearance="outline">
                        <mat-label>Transporter Name</mat-label>
                        <input matInput formControlName="transporterName" placeholder="e.g. V-Trans, SafeExpress">
                    </mat-form-field>
                </div>
                
                <!-- Section 3: Details & Confirmation -->
                <div class="section-title">3. Consignment Details</div>
                <div class="row">
                    <mat-form-field appearance="outline">
                        <mat-label>Total Qty</mat-label>
                        <input matInput type="number" formControlName="totalQty" required [readonly]="isRedirected">
                    </mat-form-field>
                    
                    <mat-form-field appearance="outline">
                        <mat-label>Total Weight (KG)</mat-label>
                        <input matInput type="number" formControlName="totalWeight" placeholder="Optional">
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Remarks / Observations</mat-label>
                        <textarea matInput formControlName="remarks" rows="1"></textarea>
                    </mat-form-field>
                </div>
                
                <!-- Section 4: Security Check -->
                <div class="section-title">4. Security Validation</div>
                <div class="row">
                    <mat-form-field appearance="outline">
                        <mat-label>Security Guard Name</mat-label>
                        <input matInput formControlName="securityGuard" required>
                    </mat-form-field>
                    
                    <mat-form-field appearance="outline">
                        <mat-label>Gate Exit Time</mat-label>
                        <input matInput [value]="gatePassForm.get('gateEntryTime')?.value | date:'medium'" readonly disabled>
                    </mat-form-field>
                </div>
                
                <div class="row checkbox-row">
                    <mat-checkbox formControlName="securitySign" color="primary">
                        CONFIRM: Consignment verified & allowed to exit.
                    </mat-checkbox>
                </div>

            </form>
        </mat-card-content>
        
        <mat-card-actions align="end">
            <button mat-button (click)="goBack()">BACK TO LIST</button>
            <button mat-button (click)="resetForm()" *ngIf="!isEditMode">RESET</button>
            <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="gatePassForm.invalid || isSaving">
                <mat-icon>{{isEditMode ? 'save' : 'logout'}}</mat-icon>
                {{isEditMode ? 'UPDATE GATE PASS' : 'GENERATE OUTWARD PASS'}}
            </button>
        </mat-card-actions>
    </mat-card>
</div>
