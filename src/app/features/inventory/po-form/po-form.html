<mat-card class="p-4 shadow-sm">
  <form [formGroup]="poForm">
    <div class="po-header-grid">
      <div class="field-item">
        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Select Supplier</mat-label>
          <mat-select formControlName="supplierId" (selectionChange)="onSupplierChange($event.value)">
            <mat-option *ngFor="let s of suppliers" [value]="s.id">{{ s.name }}</mat-option>
          </mat-select>
        </mat-form-field>
        <button mat-icon-button type="button" (click)="openSupplierModal()" color="primary">
          <mat-icon>add_circle</mat-icon>
        </button>
      </div>

      <div class="field-item">
        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Applicable Price List</mat-label>
          <mat-select formControlName="priceListId" (selectionChange)="onPriceListChange($event.value)">
            <mat-option *ngFor="let pl of priceLists" [value]="pl.id">{{ pl.name }}</mat-option>
          </mat-select>
          <mat-hint *ngIf="isPriceListAutoSelected" style="color: green; font-size: 10px;">Auto-linked from
            Supplier</mat-hint>
        </mat-form-field>
      </div>

      <div class="field-item">
        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>PO Number</mat-label>
          <input matInput formControlName="PoNumber" readonly>
        </mat-form-field>
      </div>

      <div class="field-item">
        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>PO Date</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="poDate">
          <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>
      </div>

      <div class="field-item">
        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Expected Delivery</mat-label>
          <input matInput [matDatepicker]="expPicker" formControlName="expectedDeliveryDate">
          <mat-datepicker-toggle matIconSuffix [for]="expPicker"></mat-datepicker-toggle>
          <mat-datepicker #expPicker></mat-datepicker>
        </mat-form-field>
      </div>
    </div>

    <div class="mt-4 d-flex justify-content-between align-items-center">
      <button mat-flat-button color="primary" type="button" (click)="addRow()">
        <mat-icon>add</mat-icon> Add Item
      </button>
      <span class="text-muted" style="font-size: 12px;">&nbsp;Prices will be fetched from the selected Price
        List.</span>
    </div>

    <div formArrayName="items" class="items-section mt-3">
      <div class="item-row" *ngFor="let row of items.controls; let i = index" [formGroupName]="i">

        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Search Product</mat-label>
          <input type="text" matInput formControlName="productSearch" [matAutocomplete]="auto">

          <div matSuffix *ngIf="isProductLoading[i]" style="display: flex; align-items: center; padding-right: 8px;">
            <mat-spinner diameter="18"></mat-spinner>
          </div>

          <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayProductFn"
            (optionSelected)="onProductChange(i, $event)">
            <mat-option *ngFor="let product of filteredProducts[i] | async" [value]="product">
              <span>{{product.name}}</span> - <small>{{product.sku}}</small>
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>

        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Qty</mat-label>
          <input matInput type="number" formControlName="qty" (input)="updateTotal(i)">
        </mat-form-field>

        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Unit</mat-label>
          <input matInput formControlName="unit" readonly class="bg-light">
        </mat-form-field>

        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Rate</mat-label>
          <input matInput type="number" formControlName="price" (input)="updateTotal(i)">
        </mat-form-field>

        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Disc %</mat-label>
          <input matInput type="number" formControlName="discountPercent" (input)="updateTotal(i)">
        </mat-form-field>

        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>GST %</mat-label>
          <input matInput type="number" formControlName="gstPercent" (input)="updateTotal(i)">
        </mat-form-field>

        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Tax Amt</mat-label>
          <input matInput formControlName="taxAmount" readonly class="bg-light">
        </mat-form-field>

        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Total</mat-label>
          <input matInput formControlName="total" readonly class="bg-light fw-bold text-primary">
        </mat-form-field>

        <button mat-icon-button type="button" color="warn" (click)="removeItem(i)" *ngIf="items.length > 1">
          <mat-icon>delete_outline</mat-icon>
        </button>
      </div>
    </div>

    <div class="po-footer mt-4 p-3 bg-light rounded" *ngIf="items.length">
      <div class="footer-layout">
        <div class="remarks-box">
          <mat-form-field appearance="outline" class="w-100" subscriptSizing="dynamic">
            <mat-label>Remarks / Payment Terms</mat-label>
            <textarea matInput formControlName="remarks" rows="3"></textarea>
          </mat-form-field>
        </div>

        <div class="summary-box">
          <div class="totals-container">
            <div class="total-row">
              <span>Sub-Total:</span>
              <span>₹{{ grandTotal - totalTaxAmount | number:'1.2-2' }}</span>
            </div>
            <div class="total-row">
              <span>Total Tax:</span>
              <span>₹{{ totalTaxAmount | number:'1.2-2' }}</span>
            </div>
            <hr>
            <div class="total-row grand-total">
              <strong>GRAND TOTAL:</strong>
              <strong>₹{{ grandTotal | number:'1.2-2' }}</strong>
            </div>
          </div>

          <div class="button-row">
            <button mat-flat-button class="bg-azure" (click)="saveDraft()" [disabled]="poForm.invalid || isLoading">
              <!-- <mat-icon *ngIf="!isLoading">save</mat-icon> -->
              @if (isLoading) {
              <div class="loader-overlay">
                <mat-spinner diameter="60"></mat-spinner>
              </div>}
              {{ isEditMode ? 'Update Draft (PO)' : 'Save Draft (PO)' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>
</mat-card>