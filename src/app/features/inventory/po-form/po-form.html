<mat-card class="p-4 shadow-sm">
  <div class="actions">
    <button mat-button class="back-btn" (click)="goBack()">
      <mat-icon>arrow_back</mat-icon> Back
    </button>
    <button mat-raised-button color="primary" class="save-btn" (click)="saveDraft()" [disabled]="poForm.invalid || isLoading">
      <mat-icon>save</mat-icon> {{ isEditMode ? 'Update Draft' : 'Save Draft' }}
    </button>
  </div>

  <form [formGroup]="poForm" class="mt-3">
    <div class="po-header-grid">
      <div class="field-item">
        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Select Supplier</mat-label>
          <mat-select formControlName="supplierId" (selectionChange)="onSupplierChange($event.value)" [disabled]="isLoadingSuppliers">
            <mat-option [value]="null">Please Select Supplier</mat-option>
            <mat-option *ngFor="let s of suppliers" [value]="s.id">
              {{ s.name }}
            </mat-option>
          </mat-select>
          <div matSuffix *ngIf="isLoadingSuppliers" class="dropdown-loader">
            <mat-spinner diameter="18"></mat-spinner>
          </div>
          <mat-error *ngIf="suppliers.length === 0 && !isLoadingSuppliers">
            No suppliers found.
          </mat-error>
        </mat-form-field>
      </div>

      <div class="add-btn-circle" (click)="openSupplierModal()" matTooltip="Add New Supplier">
        <mat-icon>add</mat-icon>
      </div>

      <div class="field-item">
        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Applicable Price List</mat-label>
          <mat-select formControlName="priceListId" (selectionChange)="refreshAllItemRates($event.value)" [disabled]="isLoadingPriceLists">
            <mat-option [value]="null">Please Select</mat-option>
            <mat-option *ngFor="let pl of priceLists" [value]="pl.id">
              {{ pl.name }}
            </mat-option>
          </mat-select>
          <div matSuffix *ngIf="isLoadingPriceLists" class="dropdown-loader">
            <mat-spinner diameter="18"></mat-spinner>
          </div>
          <mat-error *ngIf="priceLists.length === 0 && !isLoadingPriceLists">
            No price lists found.
          </mat-error>
          <mat-hint *ngIf="isPriceListAutoSelected" style="color: green; font-size: 10px;">
            Auto-linked from Supplier
          </mat-hint>
        </mat-form-field>
      </div>

      <div class="field-item">
        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>PO Number</mat-label>
          <input matInput formControlName="PoNumber" readonly>
        </mat-form-field>
      </div>

      <div class="field-item">
        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>PO Date</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="poDate">
          <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>
      </div>

      <div class="field-item">
        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Expected Delivery</mat-label>
          <input matInput [matDatepicker]="expPicker" formControlName="expectedDeliveryDate">
          <mat-datepicker-toggle matIconSuffix [for]="expPicker"></mat-datepicker-toggle>
          <mat-datepicker #expPicker></mat-datepicker>
        </mat-form-field>
      </div>
    </div>

    <div class="mt-4 d-flex justify-content-between align-items-center">
      <div class="d-flex gap-2 align-items-center">
        <button mat-stroked-button class="bulk-add-btn" type="button" style="margin-right: 15px;" (click)="openBulkAddDialog()">
          <mat-icon>list_alt</mat-icon> Bulk Add Items
        </button>
        <button mat-flat-button class="add-item-btn" type="button" (click)="addRow()" style="margin-right: 10px;">
          <mat-icon>add</mat-icon> Add Item
        </button>

        <span *ngIf="items.length > 0 && !isReorder" style="color: #10b981; font-weight: 600; font-size: 13px;">
          <mat-icon style="vertical-align: middle; font-size: 18px; width: 18px; height: 18px;">check_circle</mat-icon>
          {{items.length}} Item(s) added successfully
        </span>
        <span *ngIf="items.length > 0 && isReorder" 
          style="color: #800000; font-weight: 600; font-size: 13px; cursor: help;"
          [matTooltip]="reorderTooltipText" matTooltipClass="reorder-tooltip">
          <mat-icon style="vertical-align: middle; font-size: 18px; width: 18px; height: 18px;">shopping_cart</mat-icon>
          {{items.length}} Item(s) added from Reorder Cart
        </span>
      </div>
      
      <span class="text-muted" style="font-size: 12px;">Prices will be fetched from the selected Price List.</span>
    </div>

    <div formArrayName="items" class="items-section mt-3">
      <div class="item-row" *ngFor="let row of items.controls; let i = index" [formGroupName]="i">
        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Search Product</mat-label>
          <input type="text" matInput formControlName="productSearch" [matAutocomplete]="auto">
          <div matSuffix *ngIf="isProductLoading[i]" style="display: flex; align-items: center; padding-right: 8px;">
            <mat-spinner diameter="18"></mat-spinner>
          </div>
          <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayProductFn" (optionSelected)="onProductChange(i, $event)">
            <mat-option *ngFor="let product of filteredProducts[i] | async" [value]="product">
              <span>{{product.productName || product.name}}</span> - <small>{{product.sku}}</small>
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>

        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Qty</mat-label>
          <input matInput type="number" formControlName="qty" (input)="updateTotal(i)">
        </mat-form-field>

        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Unit</mat-label>
          <mat-select formControlName="unit">
            <mat-option *ngFor="let u of allUnits" [value]="u.name">{{u.name}}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Rate</mat-label>
          <input matInput type="number" formControlName="price" (input)="updateTotal(i)">
        </mat-form-field>

        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Disc %</mat-label>
          <input matInput type="number" formControlName="discountPercent" (input)="updateTotal(i)">
        </mat-form-field>

        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>GST %</mat-label>
          <input matInput type="number" formControlName="gstPercent" (input)="updateTotal(i)">
        </mat-form-field>

        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Tax Amt</mat-label>
          <input matInput formControlName="taxAmount" readonly class="bg-light">
        </mat-form-field>

        <mat-form-field appearance="outline" subscriptSizing="dynamic">
          <mat-label>Total</mat-label>
          <input matInput formControlName="total" readonly class="bg-light fw-bold text-primary">
        </mat-form-field>

        <button mat-icon-button type="button" color="warn" (click)="removeItem(i)" *ngIf="items.length > 1">
          <mat-icon>delete_outline</mat-icon>
        </button>
      </div>
    </div>

    <div class="po-footer mt-4 p-3 bg-light rounded" *ngIf="items.length">
      <div class="footer-layout">
        <div class="remarks-box">
          <mat-form-field appearance="outline" class="w-100" subscriptSizing="dynamic">
            <mat-label>Remarks / Payment Terms</mat-label>
            <textarea matInput formControlName="remarks" rows="3"></textarea>
          </mat-form-field>
        </div>

        <div class="summary-box">
          <div class="totals-container">
            <div class="total-row">
              <span>Sub-Total:</span>
              <span>₹{{ grandTotal - totalTaxAmount | number:'1.2-2' }}</span>
            </div>
            <div class="total-row">
              <span>Total Tax:</span>
              <span>₹{{ totalTaxAmount | number:'1.2-2' }}</span>
            </div>
            <hr>
            <div class="total-row grand-total">
              <strong>GRAND TOTAL:</strong>
              <strong>₹{{ grandTotal | number:'1.2-2' }}</strong>
            </div>
          </div>

          <div class="save-btn-container">
            <button mat-raised-button color="primary" class="save-btn" (click)="saveDraft()" [disabled]="poForm.invalid || isLoading">
              @if (isLoading) {
              <div class="loader-overlay">
                <mat-spinner diameter="24" style="margin-right: 8px;"></mat-spinner>
              </div>}
              {{ isEditMode ? 'Update Draft (PO)' : 'Save Draft (PO)' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>

  <!-- Floating Scroll to Top/Bottom Button -->
  <button mat-fab color="primary" class="scroll-top-btn" 
    *ngIf="items.length > 1" 
    (click)="toggleScroll()"
    [@fadeInOut]>
    <mat-icon>{{ isAtTop ? 'keyboard_arrow_down' : 'keyboard_arrow_up' }}</mat-icon>
  </button>
</mat-card>