<div class="container-fluid" [class.disabled-content]="isDashboardLoading">
  <div class="header-actions">
    <h1 class="page-title m-0">Purchase Return (Debit Note)</h1>
    <div class="d-flex gap-2">
      <button mat-raised-button 
        class="bulk-action-btn" 
        (click)="createBulkOutwardGatePass()" 
        *ngIf="selection.selected.length > 1">
        <mat-icon>merge_type</mat-icon>
        Bulk Outward ({{selection.selected.length}})
      </button>
      <button mat-raised-button 
        class="export-action-btn" 
        (click)="exportToExcel()" 
        [disabled]="isExportLoading || dataSource.data.length === 0">
        <mat-icon *ngIf="!isExportLoading">download</mat-icon>
        <mat-spinner diameter="20" *ngIf="isExportLoading" class="me-2"></mat-spinner>
        Export Excel
      </button>
      <button mat-raised-button class="main-add-btn" (click)="navigateToCreate()" [disabled]="isTableLoading">
        <mat-icon>add</mat-icon> New Return
      </button>
    </div>
  </div>

  <div class="stats-grid" *ngIf="!isDashboardLoading">
    <mat-card class="stat-card total">
        <mat-card-content>
            <div class="stat-icon"><mat-icon>payments</mat-icon></div>
            <div class="stat-info">
                <span class="label">Total Confirmed Returns</span>
                <span class="value">â‚¹{{totalReturnAmount | number:'1.2-2'}}</span>
            </div>
        </mat-card-content>
    </mat-card>

    <mat-card class="stat-card active" (click)="loadReturns()" style="cursor: pointer;">
        <mat-card-content>
            <div class="stat-icon"><mat-icon>inventory_2</mat-icon></div>
            <div class="stat-info">
                <span class="label">{{selection.selected.length > 0 ? 'Selected Qty' : 'Total Return Qty'}}</span>
                <span class="value">{{selection.selected.length > 0 ? selectedTotalQty : totalItemsReturned}} PCS</span>
            </div>
            <div class="stat-badge" style="background: #E0E7FF; color: #4338CA;">Items</div>
        </mat-card-content>
    </mat-card>

    <mat-card class="stat-card overdue" (click)="loadReturns()" style="cursor: pointer;">
        <mat-card-content>
            <div class="stat-icon"><mat-icon>check_circle</mat-icon></div>
            <div class="stat-info">
                <span class="label">Confirmed Returns</span>
                <span class="value">{{confirmedReturnsCount}}</span>
            </div>
            <div class="stat-badge" *ngIf="confirmedReturnsCount > 0">Completed</div>
        </mat-card-content>
    </mat-card>

    <mat-card class="stat-card active" (click)="loadReturns()" style="cursor: pointer;">
        <mat-card-content>
            <div class="stat-icon"><mat-icon>assignment_return</mat-icon></div>
            <div class="stat-info">
                <span class="label">Total Records</span>
                <span class="value">{{totalReturnsCount}}</span>
            </div>
        </mat-card-content>
    </mat-card>
  </div>

  <mat-card class="content-card mat-elevation-z0">
    
    <div *ngIf="isTableLoading && !isDashboardLoading" class="loader-overlay">
      <mat-spinner diameter="50"></mat-spinner>
      <p class="mt-2 text-primary fw-bold">Processing...</p>
    </div>

    <div class="filter-section">
      <mat-form-field appearance="outline" subscriptSizing="dynamic" class="search-field dense-form-field">
        <mat-label>Search Returns</mat-label>
        <mat-icon matPrefix class="text-secondary ms-2 me-2">search</mat-icon>
        <input matInput (keyup)="applySearch($event)" [(ngModel)]="searchKey" placeholder="Search by # or Supplier">
        <button mat-icon-button matSuffix *ngIf="searchKey" (click)="searchKey=''; loadReturns()">
           <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>

      <mat-form-field appearance="outline" subscriptSizing="dynamic" class="dense-form-field">
        <mat-label>Enter a date range</mat-label>
        <mat-date-range-input [rangePicker]="picker">
          <input matStartDate placeholder="Start date" [(ngModel)]="fromDate">
          <input matEndDate placeholder="End date" [(ngModel)]="toDate">
        </mat-date-range-input>
        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-date-range-picker #picker></mat-date-range-picker>
      </mat-form-field>

      <button mat-raised-button class="filter-btn" (click)="loadReturns()">
        Apply
      </button>
    </div>

    <!-- Empty State -->
    <div class="empty-state-container" *ngIf="!isTableLoading && dataSource.data.length === 0">
      <div class="empty-state-content">
        <mat-icon class="empty-icon">assignment_return</mat-icon>
        <h3 class="empty-title">No Purchase Returns Found</h3>
        <p class="empty-subtitle">We couldn't find any return records matching your search criteria.</p>
        <button mat-stroked-button color="primary" (click)="searchKey=''; loadReturns()" *ngIf="searchKey">Clear Search</button>
      </div>
    </div>

    <div *ngIf="!isTableLoading && dataSource.data.length > 0" class="table-wrapper">
      <div class="table-responsive">
        <table mat-table [dataSource]="dataSource" matSort (matSortChange)="loadReturns()">
          
          <!-- Checkbox Column -->
          <ng-container matColumnDef="select">
            <th mat-header-cell *matHeaderCellDef>
              <mat-checkbox (change)="$event ? masterToggle() : null"
                            [checked]="selection.hasValue() && isAllSelected()"
                            [indeterminate]="selection.hasValue() && !isAllSelected()"
                            color="primary">
              </mat-checkbox>
            </th>
            <td mat-cell *matCellDef="let row">
              <mat-checkbox (click)="$event.stopPropagation()"
                            (change)="$event ? selection.toggle(row) : null"
                            [checked]="selection.isSelected(row)"
                            [disabled]="row.gatePassNo"
                            color="primary">
              </mat-checkbox>
            </td>
          </ng-container>

          <ng-container matColumnDef="returnNumber">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> RETURN # </th>
            <td mat-cell *matCellDef="let row" class="bold-text"> {{row.returnNumber}} </td>
          </ng-container>
  
          <ng-container matColumnDef="gatePassNo">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> GATE PASS </th>
            <td mat-cell *matCellDef="let row">
                <ng-container *ngIf="row.gatePassNo; else noPass">
                    <div class="status-badge-container">
                        <span class="premium-badge dispatched">
                            <mat-icon>local_shipping</mat-icon>
                            DISPATCHED
                        </span>
                        <span class="pass-subtext">{{row.gatePassNo}}</span>
                    </div>
                </ng-container>
                <ng-template #noPass>
                    <button mat-icon-button (click)="createOutwardGatePass(row)" color="primary" matTooltip="Generate Outward Pass">
                        <mat-icon class="pending-pass-icon">local_shipping</mat-icon>
                    </button>
                </ng-template>
            </td>
          </ng-container>
  
          <ng-container matColumnDef="returnDate">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> DATE </th>
            <td mat-cell *matCellDef="let row"> {{row.returnDate | date:'dd-MMM-yy hh:mm a':'+0530'}} </td>
          </ng-container>
  
          <ng-container matColumnDef="supplierName">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> SUPPLIER </th>
            <td mat-cell *matCellDef="let row"> {{row.supplierName}} </td>
          </ng-container>
  
          <ng-container matColumnDef="grnRef">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> GRN REF </th>
            <td mat-cell *matCellDef="let row"> {{row.grnRef}} </td>
          </ng-container>

          <ng-container matColumnDef="totalQty">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> QTY </th>
            <td mat-cell *matCellDef="let row" class="text-center fw-bold"> 
              {{row.totalQty || row.qty || row.quantity || row.returnQty || row.returnQuantity || 0}} 
            </td>
          </ng-container>
  
          <ng-container matColumnDef="totalAmount">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> AMOUNT </th>
            <td mat-cell *matCellDef="let row"> {{row.totalAmount | currency:'INR'}} </td>
          </ng-container>
  
          <ng-container matColumnDef="status">
    <th mat-header-cell *matHeaderCellDef mat-sort-header> STATUS </th>
    <td mat-cell *matCellDef="let row">
      <span class="status-badge" 
            [ngClass]="{
              'completed': row.status === 'Completed' || row.status === 'Confirmed'
            }">
        {{ row.status }}
      </span>
    </td>
  </ng-container>
  
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="text-end pe-3"> ACTIONS </th>
            <td mat-cell *matCellDef="let row" class="text-end pe-3">
              <div class="action-buttons">
                <button mat-icon-button color="primary" title="View Details" (click)="viewDetails(row)" class="small-action-btn">
                  <mat-icon>visibility</mat-icon>
                </button>
                <button mat-icon-button color="warn" title="Print/Download" (click)="printReturn(row)" class="small-action-btn">
                  <mat-icon>print</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>
  
          <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="hover-row"></tr>
        </table>
      </div>

      <mat-paginator [length]="totalRecords" 
                     [pageSize]="pageSize" 
                     [pageSizeOptions]="[5, 10, 25]" 
                     (page)="onPageChange($event)">
      </mat-paginator>
    </div>
  </mat-card>
</div>

