<div class="page-container" [class.disabled-content]="isDashboardLoading">
    <div class="page-header">
        <h1 class="mat-headline-4">Receipt Entry</h1>
        <p class="subtitle">Record customer payments and issue receipts.</p>
    </div>

    <mat-card class="entry-card elevation-z2">
        <mat-card-header>
            <div mat-card-avatar class="header-icon bg-success">
                <mat-icon>receipt</mat-icon>
            </div>
            <mat-card-title>Recieve Payment</mat-card-title>
            <mat-card-subtitle>Enter details of payment received from customer</mat-card-subtitle>
        </mat-card-header>
        
        <mat-card-content>
            <form (ngSubmit)="saveReceipt()">
                <div class="form-grid">
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Customer Selection</mat-label>
                        <input type="text"
                               placeholder="Search name or ID"
                               matInput
                               [formControl]="customerControl"
                               [matAutocomplete]="auto"
                               required>
                        <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn" (optionSelected)="onCustomerSelected($event)">
                            <mat-option *ngFor="let customer of filteredCustomers | async" [value]="customer">
                                <span>{{customer.name}}</span> |
                                <small class="text-muted">ID: #{{customer.id}}</small>
                            </mat-option>
                        </mat-autocomplete>
                        <mat-icon matSuffix>person_search</mat-icon>
                        <mat-hint>Search and select correct customer</mat-hint>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Amount Received (₹)</mat-label>
                        <input matInput type="number" [(ngModel)]="receipt.amount" name="amount" required placeholder="0.00" min="0">
                        <mat-icon matSuffix>currency_rupee</mat-icon>
                    </mat-form-field>

                    <!-- Balance Display (Conditional) -->
                    <div class="balance-card full-width" *ngIf="currentBalance !== null" [class.settled]="currentBalance <= 0">
                        <div class="balance-label">Current Outstanding</div>
                        <div class="balance-value">
                            ₹{{currentBalance | number:'1.2-2'}}
                        </div>
                    </div>

                    <!-- Row 2 -->
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Payment Mode</mat-label>
                        <mat-select [(ngModel)]="receipt.paymentMode" name="paymentMode" required>
                            <mat-option value="Cash">
                                <mat-icon>money</mat-icon> Cash
                            </mat-option>
                            <mat-option value="Bank">
                                <mat-icon>account_balance</mat-icon> Bank Transfer
                            </mat-option>
                            <mat-option value="Check">
                                <mat-icon>padding</mat-icon> Check
                            </mat-option>
                            <mat-option value="UPI">
                                <mat-icon>qr_code</mat-icon> UPI
                            </mat-option>
                        </mat-select>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Reference / Cheque No.</mat-label>
                        <input matInput type="text" [(ngModel)]="receipt.referenceNumber" name="ref" placeholder="e.g. TXN-8842">
                        <mat-icon matSuffix>receipt_long</mat-icon>
                    </mat-form-field>
                    
                    <!-- Row 3 -->
                     <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Receipt Date</mat-label>
                        <input matInput [matDatepicker]="picker" [(ngModel)]="receipt.paymentDate" name="paymentDate" required>
                        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                        <mat-datepicker #picker></mat-datepicker>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Remarks / Notes</mat-label>
                        <textarea matInput [(ngModel)]="receipt.remarks" name="remarks" rows="1" placeholder="Add additional notes..."></textarea>
                    </mat-form-field>
                </div>

                <mat-divider></mat-divider>

                <div class="actions">
                    <button mat-button color="warn" type="button" (click)="resetForm()" [disabled]="isLoading">
                        Reset Form
                    </button>
                    <button mat-flat-button color="primary" type="submit" [disabled]="!receipt.customerId || !receipt.amount || isLoading">
                        <mat-icon *ngIf="!isLoading">save</mat-icon>
                        <mat-spinner diameter="20" *ngIf="isLoading"></mat-spinner>
                        {{isLoading ? 'Saving...' : 'Save Receipt'}}
                    </button>
                </div>
            </form>
        </mat-card-content>
    </mat-card>
</div>
