<div class="page-container" [class.disabled-content]="isDashboardLoading || isLoading">
    <div class="page-header">
        <h1 class="mat-headline-4">Customer Ledger</h1>
        <p class="subtitle">View detailed transaction history for customers.</p>
    </div>

    <!-- Search Section -->
    <mat-card class="search-card elevation-z2">
        <mat-card-content>
            <div class="search-container">
                <mat-form-field appearance="outline" class="search-field">
                    <mat-label>Search Customer</mat-label>
                    <input type="text"
                           placeholder="Ex. John Doe or ID"
                           matInput
                           [formControl]="customerControl"
                           [matAutocomplete]="auto"
                           (keydown.enter)="handleEnterKey()">
                    <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn" (optionSelected)="onCustomerSelected($event)">
                        <mat-option *ngFor="let customer of filteredCustomers | async" [value]="customer">
                            <span>{{customer.name}}</span> |
                            <small class="text-muted">ID: #{{customer.id}}</small>
                        </mat-option>
                    </mat-autocomplete>
                    <mat-icon matSuffix>person_search</mat-icon>
                </mat-form-field>

                <mat-form-field appearance="outline" class="date-field">
                    <mat-label>Start Date</mat-label>
                    <input matInput [matDatepicker]="startPicker" [(ngModel)]="filters.startDate">
                    <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
                    <mat-datepicker #startPicker></mat-datepicker>
                </mat-form-field>

                <mat-form-field appearance="outline" class="date-field">
                    <mat-label>End Date</mat-label>
                    <input matInput [matDatepicker]="endPicker" [(ngModel)]="filters.endDate">
                    <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
                    <mat-datepicker #endPicker></mat-datepicker>
                </mat-form-field>

                <button mat-flat-button color="primary" class="refresh-btn" (click)="updateReport()" [disabled]="isLoading || !customerId">
                    <mat-icon *ngIf="!isLoading">search</mat-icon>
                    <mat-spinner diameter="20" *ngIf="isLoading"></mat-spinner>
                    Show Ledger
                </button>
                <!-- Button removed as per user request -->
            </div>
        </mat-card-content>
    </mat-card>

    <!-- Ledger Content -->
    <div *ngIf="ledgerData" class="ledger-content">
        <app-summary-stats [stats]="summaryStats" [isLoading]="isLoading"></app-summary-stats>

        <!-- Summary Card: Supplier/Customer Details Only -->
        <mat-card class="summary-card elevation-z2">
            <mat-card-content>
                <div class="summary-header" style="justify-content: space-between;">
                    <div class="customer-details">
                        <mat-icon class="avatar-icon">person_pin</mat-icon>
                        <div>
                            <h2 class="customer-name">{{ledgerData.customerName}}</h2>
                            <span class="customer-id">ID: #{{customerId}}</span>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button mat-flat-button color="primary" (click)="goToReceipt()" [disabled]="currentBalance <= 0">
                            <mat-icon>add_circle_outline</mat-icon> Record Receipt
                        </button>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Transactions Table -->
        <mat-card class="table-card elevation-z2" [class.is-loading]="isLoading">
            <mat-progress-bar mode="indeterminate" color="primary" *ngIf="isLoading" class="top-loader"></mat-progress-bar>
            
            <div class="loading-shade" *ngIf="isLoading">
                <mat-spinner diameter="45"></mat-spinner>
            </div>

            <mat-card-content>
                <div class="table-container">
                    <table mat-table [dataSource]="dataSource" matSort class="full-width-table" (matSortChange)="onSortChange($event)">

                        <!-- Date Column -->
                        <ng-container matColumnDef="transactionDate">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Date </th>
                            <td mat-cell *matCellDef="let row"> {{row.transactionDate | date:'dd-MMM-yy, hh:mm a'}} </td>
                        </ng-container>

                        <!-- Type Column -->
                        <ng-container matColumnDef="transactionType">
                            <th mat-header-cell *matHeaderCellDef>
                                <div class="header-with-filter">
                                    <span mat-sort-header>Type</span>
                                    <button mat-icon-button [matMenuTriggerFor]="typeMenu" class="header-filter-btn" [class.active-filter]="filters.type" (click)="$event.stopPropagation()">
                                        <mat-icon>filter_list</mat-icon>
                                    </button>
                                    <mat-menu #typeMenu="matMenu" class="column-filter-menu">
                                        <div class="filter-menu-content" (click)="$event.stopPropagation()">
                                            <mat-form-field appearance="outline" (click)="$event.stopPropagation()">
                                                <mat-label>Filter Type</mat-label>
                                                <input matInput [(ngModel)]="filters.type" (keyup.enter)="updateReport(); typeMenu.close.emit()" placeholder="e.g. Sales">
                                            </mat-form-field>
                                            <div class="filter-actions">
                                                <button mat-button (click)="clearFilter('type'); typeMenu.close.emit()">Reset</button>
                                                <button mat-flat-button color="primary" (click)="updateReport(); typeMenu.close.emit()">Apply</button>
                                            </div>
                                        </div>
                                    </mat-menu>
                                </div>
                            </th>
                            <td mat-cell *matCellDef="let row">
                                <span class="type-badge" 
                                      [ngClass]="{'receipt': row.transactionType === 'Receipt', 'sales': row.transactionType === 'Sales'}"
                                      [matTooltip]="row.transactionType === 'Receipt' ? 'Direct Receipt' : 'Sales Entry'"
                                      matTooltipPosition="above">
                                    {{row.transactionType}}
                                </span>
                            </td>
                        </ng-container>

                        <!-- Reference Column -->
                        <ng-container matColumnDef="referenceId">
                            <th mat-header-cell *matHeaderCellDef>
                                <div class="header-with-filter">
                                    <span mat-sort-header>Reference</span>
                                    <button mat-icon-button [matMenuTriggerFor]="refMenu" class="header-filter-btn" [class.active-filter]="filters.reference" (click)="$event.stopPropagation()">
                                        <mat-icon>filter_list</mat-icon>
                                    </button>
                                    <mat-menu #refMenu="matMenu" class="column-filter-menu">
                                        <div class="filter-menu-content" (click)="$event.stopPropagation()">
                                            <mat-form-field appearance="outline" (click)="$event.stopPropagation()">
                                                <mat-label>Search Reference</mat-label>
                                                <input matInput [(ngModel)]="filters.reference" (keyup.enter)="updateReport(); refMenu.close.emit()" placeholder="Search...">
                                            </mat-form-field>
                                            <div class="filter-actions">
                                                <button mat-button (click)="clearFilter('reference'); refMenu.close.emit()">Reset</button>
                                                <button mat-flat-button color="primary" (click)="updateReport(); refMenu.close.emit()">Apply</button>
                                            </div>
                                        </div>
                                    </mat-menu>
                                </div>
                            </th>
                            <td mat-cell *matCellDef="let row" class="ref-text"> {{row.referenceId}} </td>
                        </ng-container>

                        <!-- Description Column -->
                        <ng-container matColumnDef="description">
                            <th mat-header-cell *matHeaderCellDef> Description </th>
                            <td mat-cell *matCellDef="let row" class="desc-text"> {{row.description}} </td>
                        </ng-container>

                        <!-- Debit Column -->
                        <ng-container matColumnDef="debit">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Debit (Sale) </th>
                            <td mat-cell *matCellDef="let row" class="amount-cell text-primary"> 
                                <span *ngIf="row.debit > 0">₹{{row.debit | number:'1.2-2'}}</span>
                                <span *ngIf="row.debit === 0">-</span>
                            </td>
                        </ng-container>

                        <!-- Credit Column -->
                        <ng-container matColumnDef="credit">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Credit (Received) </th>
                            <td mat-cell *matCellDef="let row" class="amount-cell text-success"> 
                                <span *ngIf="row.credit > 0">₹{{row.credit | number:'1.2-2'}}</span>
                                <span *ngIf="row.credit === 0">-</span>
                            </td>
                        </ng-container>

                        <!-- Balance Column -->
                        <ng-container matColumnDef="balance">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Balance </th>
                            <td mat-cell *matCellDef="let row" class="amount-cell fw-bold"> ₹{{row.balance | number:'1.2-2'}} </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
                        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

                        <!-- No Data Row -->
                        <tr class="mat-row" *matNoDataRow>
                            <td class="mat-cell" colspan="7" style="text-align: center; padding: 20px;">
                                No transactions found for this customer.
                            </td>
                        </tr>
                    </table>
                </div>
                <mat-paginator [length]="totalCount" 
                               [pageSize]="pageSize" 
                               [pageSizeOptions]="[10, 25, 50, 100]" 
                               (page)="onPageChange($event)"
                               showFirstLastButtons>
                </mat-paginator>
            </mat-card-content>
        </mat-card>
    </div>
</div>
