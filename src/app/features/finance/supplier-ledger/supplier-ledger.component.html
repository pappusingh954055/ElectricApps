<div class="page-container" [class.disabled-content]="isDashboardLoading">
    <div class="page-header">
        <h1 class="mat-headline-4">Supplier Ledger</h1>
        <p class="subtitle">View detailed transaction history for suppliers.</p>
    </div>

    <!-- Search Section -->
    <mat-card class="search-card elevation-z2">
        <mat-card-content>
            <div class="search-container">
                <mat-form-field appearance="outline" class="search-field">
                    <mat-label>Select Supplier (Name or ID)</mat-label>
                    <input type="text" 
                           placeholder="Search Supplier..." 
                           matInput 
                           [formControl]="supplierControl" 
                           [matAutocomplete]="auto">
                    <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn" (optionSelected)="onSupplierSelected($event)">
                        <mat-option *ngFor="let supplier of filteredSuppliers | async" [value]="supplier">
                            <div class="supplier-option">
                                <span class="supp-name">{{supplier.name}}</span>
                                <span class="supp-id">#{{supplier.id}}</span>
                            </div>
                        </mat-option>
                    </mat-autocomplete>
                    <mat-icon matSuffix>search</mat-icon>
                </mat-form-field>

                <mat-form-field appearance="outline" class="date-field">
                    <mat-label>Start Date</mat-label>
                    <input matInput [matDatepicker]="startPicker" [(ngModel)]="filters.startDate">
                    <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
                    <mat-datepicker #startPicker></mat-datepicker>
                </mat-form-field>

                <mat-form-field appearance="outline" class="date-field">
                    <mat-label>End Date</mat-label>
                    <input matInput [matDatepicker]="endPicker" [(ngModel)]="filters.endDate">
                    <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
                    <mat-datepicker #endPicker></mat-datepicker>
                </mat-form-field>

                <button mat-flat-button color="primary" class="refresh-btn" (click)="updateReport()" [disabled]="isLoading || !supplierId">
                    <mat-icon *ngIf="!isLoading">refresh</mat-icon>
                    <mat-spinner diameter="20" *ngIf="isLoading"></mat-spinner>
                    Update
                </button>
                <!-- Button removed as per user request -->
            </div>
        </mat-card-content>
    </mat-card>

    <!-- Ledger Content -->
    <div *ngIf="ledgerData" class="ledger-content">
        <!-- Summary Card -->
        <mat-card class="summary-card elevation-z2" [class.balance-positive]="currentBalance > 0">
            <mat-card-content>
                <div class="summary-header">
                    <div class="supplier-details">
                        <mat-icon class="avatar-icon">store</mat-icon>
                        <div>
                            <h2 class="supplier-name">{{ledgerData.supplierName}}</h2>
                            <span class="supplier-id">ID: #{{supplierId}}</span>
                        </div>
                    </div>
                    <div class="balance-info">
                        <span class="label">Current Balance</span>
                        <h2 class="amount">₹{{currentBalance | number:'1.2-2'}}</h2>
                        <span class="status-chip" [class.paid]="currentBalance <= 0" [class.due]="currentBalance > 0">
                            {{currentBalance > 0 ? 'Payable' : 'Settled'}}
                        </span>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Transactions Table -->
        <mat-card class="table-card elevation-z2" [class.is-loading]="isLoading">
            <mat-progress-bar mode="indeterminate" color="primary" *ngIf="isLoading" class="top-loader"></mat-progress-bar>
            
            <div class="loading-shade" *ngIf="isLoading">
                <mat-spinner diameter="45"></mat-spinner>
            </div>

            <mat-card-content>
                <div class="table-container">
                    <table mat-table [dataSource]="dataSource" matSort class="full-width-table" (matSortChange)="onSortChange($event)">

                        <!-- Date Column -->
                        <ng-container matColumnDef="transactionDate">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Date </th>
                            <td mat-cell *matCellDef="let row"> {{row.transactionDate | date:'MMM d, y, h:mm a'}} </td>
                        </ng-container>

                        <!-- Type Column -->
                        <ng-container matColumnDef="transactionType">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Type </th>
                            <td mat-cell *matCellDef="let row">
                                <span class="type-badge" 
                                      [ngClass]="{'payment': row.transactionType === 'Payment', 'purchase': row.transactionType === 'Purchase'}"
                                      [matTooltip]="row.transactionType === 'Payment' ? 'Direct payment' : 'Purchase Entry'"
                                      matTooltipPosition="above">
                                    {{row.transactionType}}
                                </span>
                            </td>
                        </ng-container>

                        <!-- Reference Column -->
                        <ng-container matColumnDef="referenceId">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Reference </th>
                            <td mat-cell *matCellDef="let row" class="ref-text"> {{row.referenceId}} </td>
                        </ng-container>

                        <!-- Description Column -->
                        <ng-container matColumnDef="description">
                            <th mat-header-cell *matHeaderCellDef> Description </th>
                            <td mat-cell *matCellDef="let row" class="desc-text"> {{row.description}} </td>
                        </ng-container>

                        <!-- Debit Column -->
                        <ng-container matColumnDef="debit">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Debit (Pay) </th>
                            <td mat-cell *matCellDef="let row" class="amount-cell text-success"> 
                                <span *ngIf="row.debit > 0">₹{{row.debit | number:'1.2-2'}}</span>
                                <span *ngIf="row.debit === 0">-</span>
                            </td>
                        </ng-container>

                        <!-- Credit Column -->
                        <ng-container matColumnDef="credit">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Credit (Supply) </th>
                            <td mat-cell *matCellDef="let row" class="amount-cell text-primary"> 
                                <span *ngIf="row.credit > 0">₹{{row.credit | number:'1.2-2'}}</span>
                                <span *ngIf="row.credit === 0">-</span>
                            </td>
                        </ng-container>

                        <!-- Balance Column -->
                        <ng-container matColumnDef="balance">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Balance </th>
                            <td mat-cell *matCellDef="let row" class="amount-cell fw-bold"> ₹{{row.balance | number:'1.2-2'}} </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
                        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

                        <!-- No Data Row -->
                        <tr class="mat-row" *matNoDataRow>
                            <td class="mat-cell" colspan="7" style="text-align: center; padding: 20px;">
                                No transactions found for this supplier.
                            </td>
                        </tr>
                    </table>
                </div>
                <mat-paginator [length]="totalCount" 
                               [pageSize]="pageSize" 
                               [pageSizeOptions]="[10, 25, 50, 100]" 
                               (page)="onPageChange($event)"
                               showFirstLastButtons>
                </mat-paginator>
            </mat-card-content>
        </mat-card>
    </div>
</div>
